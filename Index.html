<!index.html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcoustiSkin CRM (V17 - Functional Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a2a44; 
            --secondary: #0070e0; 
            --accent: #27ae60; 
            --danger: #e74c3c; 
        }
        body { font-family: 'Inter', sans-serif; background: #f4f6f9; }
        .sidebar { background: #2c3e50; }
        .nav-link { 
            border-left: 4px solid transparent;
            display: block; 
            padding: 8px 12px;
            margin-bottom: 4px;
            color: #d1d5db; 
        }
        .nav-link:hover { background: #004b9940; }
        .nav-link.active { background: #004b99 !important; border-left-color: var(--secondary) !important; color: white !important; }
        .content { display: none; }
        .content.active { display: block; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .list-item { transition: all 0.2s; }
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-[#1a2a44] text-white p-3 flex justify-between items-center shadow-lg">
        <h1 class="text-xl font-semibold">AcoustiSkin CRM V17</h1>
        <button onclick="exportData()" class="px-3 py-1 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition text-sm font-medium">
            üíæ Export Data JSON
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <div class="w-60 bg-[#2c3e50] text-white p-4 flex flex-col space-y-6 sidebar">
            <div class="text-xl font-bold text-white uppercase">AcoustiSkin V17</div>
            <nav class="space-y-1" id="sidebar-nav">
                <a href="#" class="nav-link active font-medium" data-tab="dashboard">Dashboard</a>
                <a href="#" class="nav-link font-medium" data-tab="companies">Companies (All)</a>
                <a href="#" class="nav-link font-medium" data-tab="customers">Customers</a>
                <a href="#" class="nav-link font-medium" data-tab="contacts">Contacts</a>
                <a href="#" class="nav-link font-medium" data-tab="orders">Order Entry & Tracking</a>
                <a href="#" class="nav-link font-medium" data-tab="tasks">To-Do List / Tasks</a>
                <a href="#" class="nav-link font-medium" data-tab="cases">Case Management</a>
                <a href="#" class="nav-link font-medium" data-tab="calendar">Calendar & Appointments</a>
                <a href="#" class="nav-link font-medium" data-tab="reports">Reports</a>
            </nav>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-6 bg-gray-50 overflow-y-auto" id="main-content-area">

            <div id="dashboard" class="content active">
                <div class="bg-white p-6 rounded-xl shadow-md space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Sales Overview</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-stats"></div>
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Urgent: Overdue Tasks</h3>
                        <ul class="space-y-3" id="overdue-tasks-list"></ul>
                    </div>
                </div>
            </div>

            <div id="companies" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">All Companies (Accounts)</h2>
                <button onclick="openCompanyModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition mb-4">Add New Company</button>
                <div id="company-list" class="space-y-3"></div>
            </div>

            <div id="customers" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Active Customers</h2>
                <p class="text-gray-600 mb-4">Filtered list of companies with status 'Customer'.</p>
                <div id="customer-list" class="space-y-3"></div>
            </div>

            <div id="contacts" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">All Contacts (People)</h2>
                <button onclick="openContactModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition mb-4">Add New Contact</button>
                <div id="contact-list" class="space-y-3"></div>
            </div>

            <div id="orders" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Tracking & History</h2>
                <button onclick="openOrderEntryModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition mb-4">New Phone Order</button>
                <div id="order-list" class="space-y-3"></div>
            </div>

            <div id="tasks" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">To-Do List / Tasks</h2>
                <button onclick="openTaskModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition mb-4">Add New Task</button>
                <div id="task-list-container" class="space-y-3"></div>
            </div>

            <div id="cases" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Customer Case Management (Support)</h2>
                <button onclick="openCaseModal()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg shadow-md hover:bg-yellow-700 transition mb-4">Create New Case</button>
                <div id="case-list-container" class="space-y-3"></div>
            </div>

            <div id="calendar" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Calendar & Appointments</h2>
                <div id="calendar-controls" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm mb-4"></div>
                <div id="calendar-view-container" class="bg-white p-6 rounded-xl shadow-md"></div>
            </div>

            <div id="reports" class="content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Reports & Analytics</h2>
                <div class="flex space-x-3 p-4 bg-white rounded-xl shadow-md border-b flex-wrap mb-4" id="report-buttons">
                    <button onclick="setReportType('sales')" class="report-btn px-4 py-2 text-sm rounded-lg bg-blue-600 text-white">Sales Volume (D/W/M)</button>
                    <button onclick="setReportType('tasks')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Task Performance</button>
                    <button onclick="setReportType('inventory')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Inventory Status</button>
                    <button onclick="setReportType('pickleball')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Pickleball Clubs</button>
                </div>
                <div id="report-output" class="bg-white p-6 rounded-xl shadow-md space-y-6"></div>
            </div>

        </main>
    </div>

    <!-- UNIVERSAL MODAL -->
    <div id="universalModal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl w-full modal-content p-6">
            <div class="flex justify-between items-center pb-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800" id="modal-title">Modal Title</h2>
                <button onclick="closeUniversalModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="modal-form-area"></div>
        </div>
    </div>


<script>
    // --- GLOBAL STATE ---
    let state = {
        companies: [], contacts: [], tasks: [], appointments: [], orders: [], 
        inventory: [{id: 'PBA-001', name: 'AcoustiSkin Classic', availableQty: 100, unitPrice: 19.99}, {id: 'PBA-002', name: 'AcoustiSkin Pro', availableQty: 50, unitPrice: 29.99}], 
        cases: []
    };
    let currentCalendarDate = new Date();
    let calendarViewMode = 'daily'; 
    let activeReportType = 'sales';

    // --- UTILITY FUNCTIONS ---
    const STORAGE_KEYS = {
        companies: 'crm_companies', contacts: 'crm_contacts', tasks: 'crm_tasks', 
        appointments: 'crm_appointments', orders: 'crm_orders', inventory: 'crm_inventory', cases: 'crm_cases'
    };
    const uuid = () => Math.random().toString(36).substring(2, 9);
    const formatCurrency = (amount) => `$${Number(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFraction digits: 2 })}`;
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString();
    const formatDateTime = (dateString) => new Date(dateString).toLocaleString();
    const isOverdue = (dueDate, status) => status !== 'Complete' && new Date(dueDate) < new Date();

    const loadState = () => {
        Object.keys(STORAGE_KEYS).forEach(key => {
            const stored = localStorage.getItem(STORAGE_KEYS[key]);
            if (stored) {
                try {
                    state[key] = JSON.parse(stored);
                } catch (e) {
                    console.error(`Corrupt data for ${key}. Resetting.`);
                    state[key] = (key === 'inventory') ? [{id: 'PBA-001', name: 'AcoustiSkin Classic', availableQty: 100, unitPrice: 19.99}, {id: 'PBA-002', name: 'AcoustiSkin Pro', availableQty: 50, unitPrice: 29.99}] : [];
                }
            } else {
                 if (key === 'inventory') state[key] = [{id: 'PBA-001', name: 'AcoustiSkin Classic', availableQty: 100, unitPrice: 19.99}, {id: 'PBA-002', name: 'AcoustiSkin Pro', availableQty: 50, unitPrice: 29.99}];
                 else state[key] = [];
            }
        });

        // Initialize with sample data if empty to ensure functionality
        if (state.companies.length === 0) {
            const sampleCompanyId = uuid();
            const sampleContactId = uuid();
            state.companies.push({ id: sampleCompanyId, name: 'Alpha Sound Systems', status: 'Customer', customerTier: 'Gold', revenue: 50000, employees: 25, city: 'New York', state: 'NY', owner: 'Admin', phone: '555-1212', totalValue: 50000 });
            state.contacts.push({ id: sampleContactId, firstName: 'Jane', lastName: 'Doe', companyId: sampleCompanyId, jobTitle: 'CEO', email: 'jane@alpha.com', mobile: '555-0001', reportsTo: '', dayOff: 'None', pickleballClub: 'Falmouth Air-Balls Club' });
            state.tasks.push({ id: uuid(), title: 'Follow up on Q4 Order', dueDate: '2025-11-20', status: 'Open', priority: 'High', relatedType: 'Company', relatedId: sampleCompanyId, notes: 'Confirm shipping address.' });
            state.cases.push({ id: uuid(), subject: 'Defective Product Received', contactId: sampleContactId, priority: 'High', status: 'Open', agentId: 'JT101', timeOpened: new Date().toISOString() });
        }
        saveState();
    };

    const saveState = () => {
        Object.keys(STORAGE_KEYS).forEach(key => {
            localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(state[key]));
        });
    };

    const updateEntity = (entity, data) => {
        const index = state[entity].findIndex(item => item.id === data.id);
        if (index > -1) {
            state[entity][index] = { ...state[entity][index], ...data };
        } else {
            state[entity].push({ id: uuid(), createdAt: new Date().toISOString(), ...data });
        }
        saveState();
        renderActiveTab();
    };

    const deleteEntity = (entity, id) => {
        state[entity] = state[entity].filter(item => item.id !== id);
        saveState();
        renderActiveTab();
    };

    // --- NAVIGATION & RENDERING CORE ---

    const renderActiveTab = () => {
        const activeTab = document.querySelector('.nav-link.active').dataset.tab;
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.getElementById(activeTab).classList.add('active');

        switch (activeTab) {
            case 'dashboard': renderDashboard(); break;
            case 'companies': renderCompanies(); break;
            case 'customers': renderCompanies(true); break;
            case 'contacts': renderContacts(); break;
            case 'orders': renderOrderList(); break;
            case 'tasks': renderTaskList(); break;
            case 'cases': renderCaseList(); break;
            case 'calendar': renderCalendar(); break;
            case 'reports': renderReports(); break;
        }
    };

    const setupNavigation = () => {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                renderActiveTab();
            });
        });
    };

    // --- MODAL HANDLERS ---
    const getModalContainer = () => document.getElementById('universalModal');
    const getModalFormArea = () => document.getElementById('modal-form-area');
    const getModalTitle = () => document.getElementById('modal-title');

    const openUniversalModal = (title, formHTML) => {
        getModalTitle().textContent = title;
        getModalFormArea().innerHTML = formHTML;
        getModalContainer().classList.add('active');
    };

    const closeUniversalModal = () => {
        getModalContainer().classList.remove('active');
        renderActiveTab();
    };

    window.closeUniversalModal = closeUniversalModal;

    // --- REPORTS RENDERING ---
    window.setReportType = (type) => {
        activeReportType = type;
        document.querySelectorAll('#report-buttons .report-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
        });
        document.querySelector(`#report-buttons button[onclick="setReportType('${type}')"]`).classList.add('bg-blue-600', 'text-white');
        document.querySelector(`#report-buttons button[onclick="setReportType('${type}')"]`).classList.remove('bg-gray-200', 'hover:bg-gray-300');

        renderReports();
    };

    const renderReports = () => {
        const output = document.getElementById('report-output');
        let html = '';

        if (activeReportType === 'tasks') html = renderTaskReport();
        else if (activeReportType === 'sales') html = renderSalesReports();
        else if (activeReportType === 'inventory') html = renderInventoryReport();
        else if (activeReportType === 'pickleball') html = renderPickleballReport();

        output.innerHTML = html;
    };

    const renderTaskReport = () => {
        const totalTasks = state.tasks.length;
        const completedTasks = state.tasks.filter(t => t.status === 'Complete').length;
        const overdueTasks = state.tasks.filter(t => isOverdue(t.dueDate, t.status)).length;

        return `
            <h4 class="text-xl font-bold mb-4">Task Productivity Summary</h4>
            <table class="w-full text-left table-auto">
                <thead class="bg-gray-100"><tr><th class="p-3">Metric</th><th class="p-3">Value</th></tr></thead>
                <tbody>
                    <tr><td class="p-3 border-t">Total Tasks Created</td><td class="p-3 border-t">${totalTasks}</td></tr>
                    <tr><td class="p-3 border-t">Tasks Completed</td><td class="p-3 border-t font-bold text-green-600">${completedTasks}</td></tr>
                    <tr><td class="p-3 border-t">Overdue Tasks</td><td class="p-3 border-t font-bold text-red-600">${overdueTasks}</td></tr>
                </tbody>
            </table>
        `;
    };

    const renderSalesReports = () => {
        const calculateSalesByPeriod = (period) => {
            const now = new Date();
            const startOfPeriod = new Date(now);
            if (period === 'daily') { startOfPeriod.setHours(0, 0, 0, 0); } 
            else if (period === 'weekly') { startOfPeriod.setDate(now.getDate() - now.getDay()); startOfPeriod.setHours(0, 0, 0, 0); } 
            else if (period === 'monthly') { startOfPeriod.setDate(1); startOfPeriod.setHours(0, 0, 0, 0); }

            return state.orders
                .filter(o => new Date(o.orderDate) >= startOfPeriod && o.status === 'Delivered')
                .reduce((sum, order) => sum + order.total, 0);
        };

        return `
            <h4 class="text-xl font-bold mb-4">Delivered Sales Volume (Current Period)</h4>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-600">Today</p><p class="text-2xl font-bold">${formatCurrency(calculateSalesByPeriod('daily'))}</p></div>
                <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-600">This Week</p><p class="text-2xl font-bold">${formatCurrency(calculateSalesByPeriod('weekly'))}</p></div>
                <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-600">This Month</p><p class="text-2xl font-bold">${formatCurrency(calculateSalesByPeriod('monthly'))}</p></div>
            </div>
        `;
    };

    const renderInventoryReport = () => {
        return `
            <h4 class="text-xl font-bold mb-4">Inventory Status</h4>
            <ul class="space-y-2">
                ${state.inventory.map(p => `
                    <li class="flex justify-between p-3 border rounded-lg ${p.availableQty <= 10 ? 'bg-red-100 text-red-700' : 'bg-gray-50'}">
                        <span>${p.name} (${p.id})</span>
                        <span class="font-bold">Available: ${p.availableQty}</span>
                    </li>
                `).join('')}
            </ul>
        `;
    };

    const renderPickleballReport = () => {
         const clubCounts = state.contacts.reduce((acc, contact) => {
            const club = contact.pickleballClub && contact.pickleballClub !== '' ? contact.pickleballClub : 'Unaffiliated';
            acc[club] = (acc[club] || 0) + 1;
            return acc;
        }, {});
        const totalPlayers = state.contacts.length;

        return `
            <h4 class="text-xl font-bold mb-4">Pickleball Club Segmentation</h4>
            <table class="w-full text-left table-auto">
                <thead class="bg-gray-100"><tr><th class="p-3">Club</th><th class="p-3">Count</th><th class="p-3">% of Contacts</th></tr></thead>
                <tbody>
                    ${Object.entries(clubCounts).map(([club, count]) => `
                        <tr>
                            <td class="p-3 border-t">${club}</td>
                            <td class="p-3 border-t">${count}</td>
                            <td class="p-3 border-t">${totalPlayers > 0 ? ((count / totalPlayers) * 100).toFixed(1) : 0}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    };


    // --- CALENDAR RENDERING ---

    window.changeCalendarDate = (delta) => {
        let date = new Date(currentCalendarDate);
        date.setDate(date.getDate() + delta);
        currentCalendarDate = date;
        renderCalendar();
    };

    window.setCalendarViewMode = (mode) => {
        calendarViewMode = mode;
        renderCalendar();
    };

    const renderCalendar = () => {
        renderCalendarControls();

        const container = document.getElementById('calendar-view-container');
        if (calendarViewMode === 'daily') {
            renderDailySchedule(container);
        } else {
            container.innerHTML = `<p class="p-4">${calendarViewMode.toUpperCase()} VIEW - Visualization available in the Daily view. Current date: ${currentCalendarDate.toLocaleDateString()}</p>`;
        }
    };

    const renderCalendarControls = () => {
        const controls = document.getElementById('calendar-controls');
        controls.innerHTML = `
            <div class="space-x-2">
                <button onclick="setCalendarViewMode('daily')" class="report-btn px-4 py-2 text-sm rounded-lg ${calendarViewMode === 'daily' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Daily</button>
                <button onclick="setCalendarViewMode('weekly')" class="report-btn px-4 py-2 text-sm rounded-lg ${calendarViewMode === 'weekly' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Weekly</button>
                <button onclick="setCalendarViewMode('monthly')" class="report-btn px-4 py-2 text-sm rounded-lg ${calendarViewMode === 'monthly' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Monthly</button>
            </div>
            <div class="space-x-2">
                <button onclick="changeCalendarDate(${calendarViewMode === 'monthly' ? -30 : -1})" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Prev</button>
                <span class="font-semibold text-gray-700">${currentCalendarDate.toLocaleDateString()}</span>
                <button onclick="changeCalendarDate(${calendarViewMode === 'monthly' ? 30 : 1})" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Next</button>
            </div>
        `;
    };

    const renderDailySchedule = (container) => {
        const dateStr = currentCalendarDate.toISOString().slice(0, 10);
        const dailyAppts = state.appointments.filter(a => a.date.startsWith(dateStr));

        let html = `<div class="p-4">
            <h3 class="text-xl font-semibold mb-4">Daily Schedule for ${currentCalendarDate.toLocaleDateString()}</h3>
            <button onclick="openScheduleModal('${dateStr}T09:00:00')" class="px-3 py-1 bg-accent text-white rounded-lg mb-4"> + Add Appointment</button>
            <table class="w-full text-left border-collapse">`;

        for (let h = 6; h <= 20; h++) {
            const timeSlot = `${dateStr}T${String(h).padStart(2, '0')}:00:00`;
            const appt = dailyAppts.find(a => a.date === timeSlot);
            const displayTime = new Date(timeSlot).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            html += `
                <tr onclick="openScheduleModal('${timeSlot}')" class="cursor-pointer hover:bg-gray-100 border-b">
                    <td class="w-24 font-bold p-2">${displayTime}</td>
                    <td class="p-2 ${appt ? 'bg-blue-50 text-blue-800' : 'text-gray-400'}">
                        ${appt ? `**${appt.title}** (${appt.note || 'No notes'})` : 'Click to Schedule Appointment'}
                    </td>
                </tr>`;
        }

        html += `</table></div>`;
        container.innerHTML = html;
    };

    window.openScheduleModal = (dateStr) => {
        const existingAppt = state.appointments.find(a => a.date === dateStr);
        const isNew = !existingAppt;

        const title = window.prompt(`Schedule Appointment at ${new Date(dateStr).toLocaleTimeString()}: Enter Title`, existingAppt ? existingAppt.title : '');
        if (title === null) return; 

        if (title.trim() === '' && !isNew) {
            if (window.confirm("Delete this appointment?")) deleteEntity('appointments', existingAppt.id);
            return;
        } else if (title.trim() === '') {
             return; 
        }

        const note = window.prompt("Enter notes:", existingAppt ? existingAppt.note : '');

        updateEntity('appointments', { 
            id: existingAppt ? existingAppt.id : uuid(), 
            date: dateStr, 
            title: title, 
            note: note 
        });
    };

    // --- TASK RENDERING ---

    const renderTaskList = () => {
        const taskContainer = document.getElementById('task-list-container');
        if (!taskContainer) return;

        const sortedTasks = [...state.tasks].sort((a, b) => {
            const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
            const overdueA = isOverdue(a.dueDate, a.status) ? 1 : 0;
            const overdueB = isOverdue(b.dueDate, b.status) ? 1 : 0;

            if (overdueA !== overdueB) return overdueB - overdueA; // Overdue first
            if (priorityOrder[b.priority] !== priorityOrder[a.priority]) return priorityOrder[b.priority] - priorityOrder[a.priority]; // Priority
            return new Date(a.dueDate) - new Date(b.dueDate); // Date
        });

        taskContainer.innerHTML = sortedTasks.map(t => {
            const overdue = isOverdue(t.dueDate, t.status);
            const color = t.status === 'Complete' ? 'border-green-500' : overdue ? 'border-red-500' : t.priority === 'High' ? 'border-yellow-500' : 'border-blue-500';
            const bgColor = t.status === 'Complete' ? 'bg-green-50' : overdue ? 'bg-red-50' : 'bg-white';
            const related = t.relatedType ? `${t.relatedType}: ${t.relatedId}` : 'General';

            return `
                <div class="${bgColor} p-4 rounded-xl shadow-sm border-l-4 ${color} flex justify-between items-center transition list-item">
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${t.title} <span class="text-sm font-normal text-gray-600">(${t.status})</span></p>
                        <p class="text-sm text-gray-500">Due: <strong>${formatDate(t.dueDate)}</strong> | Priority: ${t.priority} | Related: ${related}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select onchange="updateTaskStatus('${t.id}', this.value)" class="p-2 border rounded-lg text-sm bg-white">
                            ${['Open', 'In Progress', 'Complete'].map(s => `<option value="${s}" ${t.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                        <button onclick="openTaskModal('${t.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                    </div>
                </div>
            `;
        }).join('') || '<p class="p-4 bg-white rounded-lg">No tasks scheduled.</p>';
    });
};

window.updateTaskStatus = (id, status) => {
    updateEntity('tasks', { id, status });
};

// --- CASE RENDERING ---
const renderCaseList = () => {
    const container = document.getElementById('case-list-container');
    if (!container) return;

    const sortedCases = [...state.cases].sort((a, b) => {
        const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
        return priorityOrder[b.priority] - priorityOrder[a.priority];
    });

    container.innerHTML = sortedCases.map(c => {
        const contact = state.contacts.find(con => con.id === c.contactId);
        const statusColor = c.status === 'Resolved' || c.status === 'Closed' ? 'border-green-500' : c.status === 'Open' ? 'border-red-500' : 'border-yellow-500';

        return `
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${statusColor} flex justify-between items-center transition list-item">
                <div>
                    <p class="text-lg font-semibold text-gray-800">${c.subject}</p>
                    <p class="text-sm text-gray-500">Customer: ${contact ? `${contact.firstName} ${contact.lastName}` : 'N/A'} | Agent: ${c.agentId}</p>
                    <p class="xs text-gray-500">Opened: ${formatDateTime(c.timeOpened)} | Priority: ${c.priority}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium px-3 py-1 rounded-full ${c.status === 'Open' ? 'bg-red-500' : 'bg-blue-500'} text-white">${c.status}</span>
                    <button onclick="openCaseModal('${c.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                </div>
            </div>
        `;
    }).join('') || '<p class="p-4 bg-white rounded-lg">No support cases currently open. Great service!</p>';
};

// --- DASHBOARD RENDERING ---
const renderDashboard = () => {
    const totalCustomers = state.companies.filter(c => c.status === 'Customer').length;
    const totalOpenTasks = state.tasks.filter(t => t.status !== 'Complete').length;
    const totalRevenue = state.orders.reduce((sum, order) => sum + order.total, 0);
    const totalOpenCases = state.cases.filter(c => c.status !== 'Closed' && c.status !== 'Resolved').length;

    const statsHtml = `
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-600">
            <p class="text-sm text-gray-500">Total Customers</p>
            <h3 class="text-3xl font-bold mt-1 text-blue-600">${totalCustomers}</h3>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
            <p class="text-sm text-gray-500">Total Revenue</p>
            <h3 class="text-3xl font-bold mt-1 text-green-600">${formatCurrency(totalRevenue)}</h3>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
            <p class="text-sm text-gray-500">Open Tasks</p>
            <h3 class="text-3xl font-bold mt-1 text-yellow-500">${totalOpenTasks}</h3>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-red-600">
            <p class="text-sm text-gray-500">Open Support Cases</p>
            <h3 class="text-3xl font-bold mt-1 text-red-600">${totalOpenCases}</h3>
        </div>
    `;
    document.getElementById('dashboard-stats').innerHTML = statsHtml;

    const overdueTasks = state.tasks.filter(t => isOverdue(t.dueDate, t.status));
    const overdueList = document.getElementById('overdue-tasks-list');

    if (overdueTasks.length > 0) {
        overdueList.innerHTML = overdueTasks.map(t => `
            <li class="p-3 bg-red-50 border border-red-200 rounded-lg flex justify-between items-center">
                <div>
                    <p class="font-medium text-red-700">${t.title}</p>
                    <p class="text-sm text-red-500">Due: ${formatDate(t.dueDate)}</p>
                </div>
                <button onclick="openTaskModal('${t.id}')" class="text-red-700 hover:text-red-900 text-sm font-medium">Edit</button>
            </li>
        `).join('');
    } else {
         overdueList.innerHTML = '<p class="text-gray-500">No overdue tasks. Great job!</p>';
    }

};


// --- IMPLEMENTATION FUNCTIONS (List Rendering) ---

const renderCompanies = (isCustomerView = false) => {
    const container = isCustomerView ? document.getElementById('customer-list') : document.getElementById('company-list');
    let list = state.companies;
    if (isCustomerView) {
        list = list.filter(c => c.status === 'Customer');
    }
    const sortedList = [...list].sort((a, b) => a.name.localeCompare(b.name));

    container.innerHTML = sortedList.map(c => `
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center list-item">
          <div>
            <p class="text-lg font-semibold text-gray-800">${c.name} 
                <span class="text-xs font-medium px-2 py-1 rounded-full ml-2 ${c.status === 'Customer' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">${c.status}</span>
                <span class="text-xs font-medium px-2 py-1 rounded-full ml-2 bg-yellow-100 text-yellow-700">${c.customerTier || 'None'}</span>
            </p>
            <p class="text-sm text-gray-500">Owner: ${c.owner || 'N/A'} | Revenue: ${formatCurrency(c.revenue)}</p>
          </div>
          <button onclick="openCompanyModal('${c.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 rounded-lg border border-blue-600 hover:border-blue-800 transition">Edit</button>
        </div>
    `).join('') || `<p class="p-4 bg-white rounded-lg">No records found.</p>`;
};

const renderContacts = () => {
    const container = document.getElementById('contact-list');
    const sortedList = [...state.contacts].sort((a, b) => a.lastName.localeCompare(b.lastName));

    container.innerHTML = sortedList.map(c => {
        const companyName = state.companies.find(comp => comp.id === c.companyId)?.name || 'Unassigned';
        return `
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center list-item">
                <div>
                    <p class="text-lg font-semibold text-gray-800">${c.lastName}, ${c.firstName} <span class="text-sm font-normal text-gray-600">(${c.jobTitle || 'N/A'})</span></p>
                    <p class="text-sm text-gray-500">Company: ${companyName} | Mobile: ${c.mobile || 'N/A'}</p>
                    ${c.pickleballClub ? `<p class="text-xs font-medium text-purple-600 mt-1">üèì Club: ${c.pickleballClub}</p>` : ''}
                </div>
                <div class="flex space-x-2">
                    <button onclick="openCaseModal(null, '${c.id}')" class="px-3 py-1 bg-yellow-500 text-white text-sm font-medium rounded-lg hover:bg-yellow-600 transition">New Case</button>
                    <button onclick="openContactModal('${c.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 rounded-lg border border-blue-600 hover:border-blue-800 transition">Edit</button>
                </div>
            </div>
        `;
    }).join('') || `<p class="p-4 bg-white rounded-lg">No contacts found.</p>`;
};

// --- LIFECYCLE ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    setupNavigation();
    renderActiveTab();
});
