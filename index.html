<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM – Enterprise V18</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#1a2a44; --secondary:#0070e0; --accent:#27ae60; --danger:#e74c3c; }
    body { font-family:'Inter',sans-serif; background:#f4f6f9; }
    .sidebar { background:#2c3e50; }
    .nav-link { border-left:4px solid transparent; display:block; padding:8px 12px; margin-bottom:4px; color:#d1d5db; }
    .nav-link:hover { background:#004b9940; }
    .nav-link.active { background:#004b99 !important; border-left-color:var(--secondary)!important; color:white!important; }
    .content { display:none; }
    .content.active { display:block; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:50; justify-content:center; align-items:center; }
    .modal.active { display:flex; }
    .modal-content { max-width:1100px; max-height:95vh; overflow-y:auto; }
    .list-item { transition:all .2s; }
    .list-item:hover { transform:translateY(-2px); box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .cal-day { min-height:80px; border:1px solid #e5e7eb; padding:4px; cursor:pointer; }
    .cal-day:hover { background:#f3f4f6; }
    .cal-day.today { background:#dbeafe; }
    .cal-slot { font-size:0.75rem; margin:1px 0; padding:1px 2px; border-radius:2px; }
    .search-results { max-height:200px; overflow-y:auto; border:1px solid #ddd; background:white; }
    .search-result:hover { background:#f0f0f0; cursor:pointer; }
  </style>
</head>
<body class="h-screen flex flex-col">

<header class="bg-[#1a2a44] text-white p-3 flex justify-between items-center shadow-lg">
  <h1 class="text-xl font-semibold">AcoustiSkin CRM V18</h1>
  <button onclick="exportData()" class="px-3 py-1 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition text-sm font-medium">
    Export Data JSON
  </button>
</header>

<div class="flex flex-1 overflow-hidden">
  <div class="w-60 bg-[#2c3e50] text-white p-4 flex flex-col space-y-6 sidebar">
    <div class="text-xl font-bold text-white uppercase">AcoustiSkin V18</div>
    <nav class="space-y-1" id="sidebar-nav">
      <a href="#" class="nav-link active font-medium" data-tab="dashboard">Dashboard</a>
      <a href="#" class="nav-link font-medium" data-tab="companies">Companies</a>
      <a href="#" class="nav-link font-medium" data-tab="customers">Customers</a>
      <a href="#" class="nav-link font-medium" data-tab="contacts">Contacts</a>
      <a href="#" class="nav-link font-medium" data-tab="orders">Orders</a>
      <a href="#" class="nav-link font-medium" data-tab="tasks">Tasks</a>
      <a href="#" class="nav-link font-medium" data-tab="cases">Cases</a>
      <a href="#" class="nav-link font-medium" data-tab="calendar">Calendar</a>
      <a href="#" class="nav-link font-medium" data-tab="reports">Reports</a>
    </nav>
  </div>

  <main class="flex-1 p-6 bg-gray-50 overflow-y-auto" id="main-content-area">

    <div id="dashboard" class="content active">
      <div class="bg-white p-6 rounded-xl shadow-md space-y-6">
        <h2 class="text-2xl font-bold text-gray-800">Sales Overview</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-stats"></div>
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
          <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Urgent: Overdue Tasks</h3>
          <ul class="space-y-3" id="overdue-tasks-list"></ul>
        </div>
      </div>
    </div>

    <div id="companies" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">All Companies</h2>
      <button onclick="openCompanyModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 mb-4">Add Company</button>
      <div id="company-list" class="space-y-3"></div>
    </div>

    <div id="customers" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Active Customers</h2>
      <div id="customer-list" class="space-y-3"></div>
    </div>

    <div id="contacts" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">All Contacts</h2>
      <button onclick="openContactModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 mb-4">Add Contact</button>
      <div id="contact-list" class="space-y-3"></div>
    </div>

    <div id="orders" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Entry & Tracking</h2>
      <button onclick="openOrderEntryModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 mb-4">New Order</button>
      <div id="order-list" class="space-y-3"></div>
    </div>

    <div id="tasks" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">To-Do List / Tasks</h2>
      <button onclick="openTaskModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 mb-4">Add Task</button>
      <div id="task-list-container" class="space-y-3"></div>
    </div>

    <div id="cases" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Case Management</h2>
      <button onclick="openCaseModal()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg shadow-md hover:bg-yellow-700 mb-4">New Case</button>
      <div id="case-list-container" class="space-y-3"></div>
    </div>

    <div id="calendar" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Calendar & Appointments</h2>
      <div id="calendar-controls" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm mb-4"></div>
      <div id="calendar-view-container" class="bg-white p-6 rounded-xl shadow-md"></div>
    </div>

    <div id="reports" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Reports & Analytics</h2>
      <div class="flex space-x-3 p-4 bg-white rounded-xl shadow-md border-b mb-4" id="report-buttons">
        <button onclick="setReportType('sales')" class="report-btn px-4 py-2 text-sm rounded-lg bg-blue-600 text-white">Sales</button>
        <button onclick="setReportType('tasks')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Tasks</button>
        <button onclick="setReportType('inventory')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Inventory</button>
        <button onclick="setReportType('pickleball')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Pickleball</button>
      </div>
      <div id="report-output" class="bg-white p-6 rounded-xl shadow-md space-y-6"></div>
    </div>

  </main>
</div>

<div id="universalModal" class="modal">
  <div class="bg-white rounded-xl shadow-2xl w-full modal-content p-6">
    <div class="flex justify-between items-center pb-4 border-b">
      <h2 class="text-xl font-semibold text-gray-800" id="modal-title">Modal</h2>
      <button onclick="closeUniversalModal()" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="modal-form-area"></div>
  </div>
</div>

<script>
/* ==================== GLOBAL STATE ==================== */
let state = {
  companies: [], contacts: [], tasks: [], appointments: [], orders: [],
  inventory: [
    {id:'PBA-001',name:'AcoustiSkin Classic',availableQty:100,unitPrice:19.99,variants:{size:['S','M','L','XL'],color:['Black','Blue']}},
    {id:'PBA-002',name:'AcoustiSkin Pro',availableQty:50,unitPrice:29.99,variants:{size:['M','L'],color:['White']}}
  ],
  cases: []
};
let currentCalendarDate = new Date();
let calendarViewMode = 'daily';
let activeReportType = 'sales';
let currentCart = [];
let selectedCustomer = null;

/* ==================== UTILITIES ==================== */
const STORAGE_KEYS = {
  companies:'crm_companies',contacts:'crm_contacts',tasks:'crm_tasks',
  appointments:'crm_appointments',orders:'crm_orders',inventory:'crm_inventory',cases:'crm_cases'
};
const uuid = () => Math.random().toString(36).substring(2,9);
const formatCurrency = a => `$${Number(a||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
const formatDate = d => new Date(d).toLocaleDateString();
const formatDateTime = d => new Date(d).toLocaleString(); 
const isOverdue = (due,status) => status!=='Complete' && new Date(due)<new Date();
const deleteEntity = (ent,id) => { 
  state[ent] = state[ent].filter(i => i.id !== id);
  saveState();
  renderActiveTab();
};

/* ==================== STORAGE ==================== */
const loadState = () => {
  Object.keys(STORAGE_KEYS).forEach(k => {
    const s = localStorage.getItem(STORAGE_KEYS[k]);
    if (s) try { state[k] = JSON.parse(s); } catch (e) { console.error('Corrupt',k); }
    else if (k === 'inventory') state[k] = [
      {id:'PBA-001',name:'AcoustiSkin Classic',availableQty:100,unitPrice:19.99,variants:{size:['S','M','L','XL'],color:['Black','Blue']}},
      {id:'PBA-002',name:'AcoustiSkin Pro',availableQty:50,unitPrice:29.99,variants:{size:['M','L'],color:['White']}}
    ];
    else state[k] = [];
  });
  if (state.companies.length === 0) {
    const cid = uuid(), pid = uuid();
    state.companies.push({id:cid,name:'Alpha Sound Systems',status:'Customer',customerTier:'Gold',revenue:50000,owner:'Admin',industry:'Tech',phone:'555-1212',address:'101 Elm St'});
    state.contacts.push({id:pid,firstName:'Jane',lastName:'Doe',companyId:cid,jobTitle:'CEO',email:'jane@alpha.com',phone:'555-0001',mobile:'555-0002'});
    state.tasks.push({id:uuid(),title:'Follow up Q4 Order',dueDate:'2025-11-20',status:'Open',priority:'High',relatedType:'Company',relatedId:cid,time:'10:00'});
    state.cases.push({id:uuid(),subject:'Defective Product',contactId:pid,priority:'High',status:'Open',agentId:'JT101',timeOpened:new Date().toISOString(), type:'RMA'});
  }
  saveState();
};
const saveState = () => Object.keys(STORAGE_KEYS).forEach(k => localStorage.setItem(STORAGE_KEYS[k],JSON.stringify(state[k])));
const updateEntity = (ent,data) => {
  const idx = state[ent].findIndex(i => i.id === data.id);
  if (idx > -1) state[ent][idx] = {...state[ent][idx],...data};
  else state[ent].push({id:uuid(),createdAt:new Date().toISOString(),...data});
  saveState(); renderActiveTab();
};

/* ==================== NAVIGATION ==================== */
const renderActiveTab = () => {
  const activeLink = document.querySelector('.nav-link.active');
  if (!activeLink) return;
  const tab = activeLink.dataset.tab;
  document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
  const el = document.getElementById(tab);
  if (el) el.classList.add('active');

  const fns = {
    dashboard: renderDashboard,
    companies: () => renderCompanies(false),
    customers: () => renderCompanies(true),
    contacts: renderContacts,
    orders: renderOrderList,
    tasks: renderTaskList,
    cases: renderCaseList,
    calendar: renderCalendar,
    reports: renderReports
  };
  if (fns[tab]) fns[tab]();
};
document.addEventListener('DOMContentLoaded', () => {
  loadState();
  document.querySelectorAll('.nav-link').forEach(l => {
    l.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
      l.classList.add('active');
      renderActiveTab();
    });
  });
  renderActiveTab();
});

/* ==================== MODAL HELPERS ==================== */
const openUniversalModal = (title, html) => {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-form-area').innerHTML = html;
  document.getElementById('universalModal').classList.add('active');
};
const closeUniversalModal = () => {
  document.getElementById('universalModal').classList.remove('active');
  renderActiveTab();
};
window.closeUniversalModal = closeUniversalModal;

/* ==================== CALENDAR (Point 8) ==================== */
window.changeCalendarDate = delta => {
  if (calendarViewMode === 'daily') currentCalendarDate.setDate(currentCalendarDate.getDate() + delta);
  else if (calendarViewMode === 'weekly') currentCalendarDate.setDate(currentCalendarDate.getDate() + delta * 7);
  else if (calendarViewMode === 'monthly') currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
  renderCalendar();
};
window.setCalendarViewMode = mode => { calendarViewMode = mode; renderCalendar(); };
const renderCalendar = () => {
  renderCalendarControls();
  const c = document.getElementById('calendar-view-container');
  calendarViewMode === 'daily' ? renderDaily(c) :
  calendarViewMode === 'weekly' ? renderWeekly(c) :
  renderMonthly(c);
};
const renderCalendarControls = () => {
  const ctrl = document.getElementById('calendar-controls');
  const label = calendarViewMode === 'daily' ? currentCalendarDate.toLocaleDateString() :
                calendarViewMode === 'weekly' ? `Week of ${getWeekStart(new Date(currentCalendarDate)).toLocaleDateString()}` :
                currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
  ctrl.innerHTML = `
    <div class="space-x-2">
      <button onclick="setCalendarViewMode('daily')" class="px-4 py-2 text-sm rounded-lg ${calendarViewMode==='daily'?'bg-blue-600 text-white':'bg-gray-200 hover:bg-gray-300'}">Daily</button>
      <button onclick="setCalendarViewMode('weekly')" class="px-4 py-2 text-sm rounded-lg ${calendarViewMode==='weekly'?'bg-blue-600 text-white':'bg-gray-200 hover:bg-gray-300'}">Weekly</button>
      <button onclick="setCalendarViewMode('monthly')" class="px-4 py-2 text-sm rounded-lg ${calendarViewMode==='monthly'?'bg-blue-600 text-white':'bg-gray-200 hover:bg-gray-300'}">Monthly</button>
    </div>
    <div class="space-x-2">
      <button onclick="changeCalendarDate(-1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">Prev</button>
      <span class="font-semibold text-gray-700">${label}</span>
      <button onclick="changeCalendarDate(1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">Next</button>
    </div>`;
};
const getWeekStart = d => {
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  const start = new Date(d);
  start.setDate(diff);
  return start;
};
// Helper to get appts for a day
const getApptsForDay = (ds) => {
    const appts = state.appointments.filter(a => a.date.startsWith(ds));
    const tasks = state.tasks.filter(t => t.dueDate === ds);
    return [...appts, ...tasks.map(t => ({
        ...t,
        isTask: true,
        title: `Task: ${t.title} (${t.priority})`,
        time: t.time || 'All Day' // Use time if available
    }))];
};
const renderDaily = c => {
  const ds = currentCalendarDate.toISOString().slice(0,10);
  const events = getApptsForDay(ds);
  let html = `<div class="p-4"><h3 class="text-xl font-semibold mb-4">Daily – ${currentCalendarDate.toLocaleDateString()}</h3>
              <button onclick="openScheduleModal('${ds}T09:00')" class="px-3 py-1 bg-green-600 text-white rounded-lg mb-4">+ Appointment</button>
              <button onclick="openTaskModal(null,'${ds}')" class="px-3 py-1 bg-blue-600 text-white rounded-lg mb-4 ml-2">+ To-Do</button>
              <table class="w-full text-left border-collapse">`;
  
  // Create a map for quick event lookup by hour slot
  const eventMap = {};
  events.forEach(e => {
    const hour = e.isTask && e.time === 'All Day' ? 'All Day' : new Date(e.date || `${ds}T${e.time}:00`).getHours();
    if (!eventMap[hour]) eventMap[hour] = [];
    eventMap[hour].push(e);
  });
  
  // Render "All Day" events first
  const allDayEvents = eventMap['All Day'] || [];
  if (allDayEvents.length > 0) {
      html += `<tr class="border-b bg-gray-100">
                <td class="w-24 font-bold p-2 text-red-600">All Day</td>
                <td class="p-2">
                    ${allDayEvents.map(e => `<p class="text-sm cursor-pointer" onclick="event.stopPropagation(); ${e.isTask ? `openTaskModal('${e.id}')` : `openScheduleModal('${e.date}')`}">${e.title}</p>`).join('')}
                </td>
              </tr>`;
  }
  
  for(let h=6;h<=20;h++){
    const slot = `${ds}T${String(h).padStart(2,'0')}:00`;
    const eventsInHour = eventMap[h] || [];
    const time = new Date(slot).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    
    html += `<tr onclick="openScheduleModal('${slot}')" class="cursor-pointer hover:bg-gray-100 border-b">
                <td class="w-24 font-bold p-2">${time}</td>
                <td class="p-2 ${eventsInHour.length > 0 ? 'bg-blue-50 text-blue-800' : 'text-gray-400'}">
                  ${eventsInHour.length > 0 ? 
                    eventsInHour.map(e => `<p class="text-sm cursor-pointer" onclick="event.stopPropagation(); ${e.isTask ? `openTaskModal('${e.id}')` : `openScheduleModal('${e.date}')`}">${e.title}</p>`).join('')
                    : 'Click to schedule'}
                </td></tr>`;
  }
  html += `</table></div>`;
  c.innerHTML = html;
};
const renderWeekly = c => {
    const start = getWeekStart(new Date(currentCalendarDate));
    let html = `<div class="p-4"><h3 class="text-xl font-semibold mb-4">Weekly</h3>
                <div class="grid grid-cols-7 gap-2 text-center font-semibold mb-2">`;
    
    const oneDay = 24 * 60 * 60 * 1000;
    const today = new Date().toDateString();

    for(let i=0;i<7;i++){
        const day = new Date(start); day.setDate(start.getDate()+i);
        const ds = day.toISOString().slice(0,10);
        const events = getApptsForDay(ds); 
        const isToday = day.toDateString() === today;
        
        const sortedEvents = events.sort((a, b) => {
            const timeA = a.time === 'All Day' ? -1 : parseInt((a.date || a.time).slice(0, 2));
            const timeB = b.time === 'All Day' ? -1 : parseInt((b.date || b.time).slice(0, 2));
            return timeA - timeB;
        });

        html += `<div class="cal-day ${isToday?'today':''}" onclick="setCalendarViewMode('daily'); currentCalendarDate.setDate(${day.getDate()}); renderCalendar();">
                    <strong>${day.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</strong>
                    <button onclick="event.stopPropagation(); openScheduleModal('${ds}T09:00')" class="text-xs text-green-600">+
