<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM (V17 – Fully Working)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#1a2a44; --secondary:#0070e0; --accent:#27ae60; --danger:#e74c3c; }
    body { font-family:'Inter',sans-serif; background:#f4f6f9; }
    .sidebar { background:#2c3e50; }
    .nav-link { border-left:4px solid transparent; display:block; padding:8px 12px; margin-bottom:4px; color:#d1d5db; }
    .nav-link:hover { background:#004b9940; }
    .nav-link.active { background:#004b99 !important; border-left-color:var(--secondary)!important; color:white!important; }
    .content { display:none; }
    .content.active { display:block; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:50; justify-content:center; align-items:center; }
    .modal.active { display:flex; }
    .modal-content { max-width:900px; max-height:90vh; overflow-y:auto; }
    .list-item { transition:all .2s; }
    .list-item:hover { transform:translateY(-2px); box-shadow:0 4px 6px rgba(0,0,0,.1); }
  </style>
</head>
<body class="h-screen flex flex-col">

<header class="bg-[#1a2a44] text-white p-3 flex justify-between items-center shadow-lg">
  <h1 class="text-xl font-semibold">AcoustiSkin CRM V17</h1>
  <button onclick="exportData()" class="px-3 py-1 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition text-sm font-medium">
    Export Data JSON
  </button>
</header>

<div class="flex flex-1 overflow-hidden">
  <!-- Sidebar -->
  <div class="w-60 bg-[#2c3e50] text-white p-4 flex flex-col space-y-6 sidebar">
    <div class="text-xl font-bold text-white uppercase">AcoustiSkin V17</div>
    <nav class="space-y-1" id="sidebar-nav">
      <a href="#" class="nav-link active font-medium" data-tab="dashboard">Dashboard</a>
      <a href="#" class="nav-link font-medium" data-tab="companies">Companies (All)</a>
      <a href="#" class="nav-link font-medium" data-tab="customers">Customers</a>
      <a href="#" class="nav-link font-medium" data-tab="contacts">Contacts</a>
      <a href="#" class="nav-link font-medium" data-tab="orders">Order Entry & Tracking</a>
      <a href="#" class="nav-link font-medium" data-tab="tasks">To-Do List / Tasks</a>
      <a href="#" class="nav-link font-medium" data-tab="cases">Case Management</a>
      <a href="#" class="nav-link font-medium" data-tab="calendar">Calendar & Appointments</a>
      <a href="#" class="nav-link font-medium" data-tab="reports">Reports</a>
    </nav>
  </div>

  <!-- Main Content -->
  <main class="flex-1 p-6 bg-gray-50 overflow-y-auto" id="main-content-area">

    <!-- DASHBOARD -->
    <div id="dashboard" class="content active">
      <div class="bg-white p-6 rounded-xl shadow-md space-y-6">
        <h2 class="text-2xl font-bold text-gray-800">Sales Overview</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-stats"></div>
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
          <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Urgent: Overdue Tasks</h3>
          <ul class="space-y-3" id="overdue-tasks-list"></ul>
        </div>
      </div>
    </div>

    <!-- COMPANIES -->
    <div id="companies" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">All Companies (Accounts)</h2>
      <button onclick="openCompanyModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition mb-4">Add New Company</button>
      <div id="company-list" class="space-y-3"></div>
    </div>

    <!-- CUSTOMERS -->
    <div id="customers" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Active Customers</h2>
      <p class="text-gray-600 mb-4">Filtered list of companies with status 'Customer'.</p>
      <div id="customer-list" class="space-y-3"></div>
    </div>

    <!-- CONTACTS -->
    <div id="contacts" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">All Contacts (People)</h2>
      <button onclick="openContactModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition mb-4">Add New Contact</button>
      <div id="contact-list" class="space-y-3"></div>
    </div>

    <!-- ORDERS -->
    <div id="orders" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Tracking & History</h2>
      <button onclick="openOrderEntryModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition mb-4">New Phone Order</button>
      <div id="order-list" class="space-y-3"></div>
    </div>

    <!-- TASKS -->
    <div id="tasks" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">To-Do List / Tasks</h2>
      <button onclick="openTaskModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition mb-4">Add New Task</button>
      <div id="task-list-container" class="space-y-3"></div>
    </div>

    <!-- CASES -->
    <div id="cases" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Customer Case Management (Support)</h2>
      <button onclick="openCaseModal()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg shadow-md hover:bg-yellow-700 transition mb-4">Create New Case</button>
      <div id="case-list-container" class="space-y-3"></div>
    </div>

    <!-- CALENDAR -->
    <div id="calendar" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Calendar & Appointments</h2>
      <div id="calendar-controls" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm mb-4"></div>
      <div id="calendar-view-container" class="bg-white p-6 rounded-xl shadow-md"></div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Reports & Analytics</h2>
      <div class="flex space-x-3 p-4 bg-white rounded-xl shadow-md border-b flex-wrap mb-4" id="report-buttons">
        <button onclick="setReportType('sales')" class="report-btn px-4 py-2 text-sm rounded-lg bg-blue-600 text-white">Sales Volume (D/W/M)</button>
        <button onclick="setReportType('tasks')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Task Performance</button>
        <button onclick="setReportType('inventory')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Inventory Status</button>
        <button onclick="setReportType('pickleball')" class="report-btn px-4 py-2 text-sm rounded-lg bg-gray-200 hover:bg-gray-300">Pickleball Clubs</button>
      </div>
      <div id="report-output" class="bg-white p-6 rounded-xl shadow-md space-y-6"></div>
    </div>

  </main>
</div>

<!-- UNIVERSAL MODAL -->
<div id="universalModal" class="modal">
  <div class="bg-white rounded-xl shadow-2xl w-full modal-content p-6">
    <div class="flex justify-between items-center pb-4 border-b">
      <h2 class="text-xl font-semibold text-gray-800" id="modal-title">Modal Title</h2>
      <button onclick="closeUniversalModal()" class="text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="modal-form-area"></div>
  </div>
</div>

<script>
/* ==================== GLOBAL STATE ==================== */
let state = {
  companies: [], contacts: [], tasks: [], appointments: [], orders: [],
  inventory: [
    {id:'PBA-001',name:'AcoustiSkin Classic',availableQty:100,unitPrice:19.99},
    {id:'PBA-002',name:'AcoustiSkin Pro',availableQty:50,unitPrice:29.99}
  ],
  cases: []
};
let currentCalendarDate = new Date();
let calendarViewMode = 'daily';
let activeReportType = 'sales';

/* ==================== UTILITIES ==================== */
const STORAGE_KEYS = {
  companies:'crm_companies',contacts:'crm_contacts',tasks:'crm_tasks',
  appointments:'crm_appointments',orders:'crm_orders',inventory:'crm_inventory',cases:'crm_cases'
};
const uuid = () => Math.random().toString(36).substring(2,9);
const formatCurrency = a => `$${Number(a||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
const formatDate = d => new Date(d).toLocaleDateString();
const formatDateTime = d => new Date(d).toLocaleString();
const isOverdue = (due,status) => status!=='Complete' && new Date(due)<new Date();

/* ==================== STORAGE ==================== */
const loadState = () => {
  Object.keys(STORAGE_KEYS).forEach(k=>{
    const s = localStorage.getItem(STORAGE_KEYS[k]);
    if(s){ try{ state[k]=JSON.parse(s); }catch(e){ console.error('Corrupt',k); } }
    else if(k==='inventory') state[k]=[
      {id:'PBA-001',name:'AcoustiSkin Classic',availableQty:100,unitPrice:19.99},
      {id:'PBA-002',name:'AcoustiSkin Pro',availableQty:50,unitPrice:29.99}
    ];
    else state[k]=[];
  });
  if(state.companies.length===0){
    const cid=uuid(), pid=uuid();
    state.companies.push({id:cid,name:'Alpha Sound Systems',status:'Customer',customerTier:'Gold',revenue:50000,owner:'Admin'});
    state.contacts.push({id:pid,firstName:'Jane',lastName:'Doe',companyId:cid,jobTitle:'CEO',mobile:'555-0001',pickleballClub:'Falmouth Air-Balls Club'});
    state.tasks.push({id:uuid(),title:'Follow up Q4 Order',dueDate:'2025-11-20',status:'Open',priority:'High',relatedType:'Company',relatedId:cid});
    state.cases.push({id:uuid(),subject:'Defective Product',contactId:pid,priority:'High',status:'Open',agentId:'JT101',timeOpened:new Date().toISOString()});
  }
  saveState();
};
const saveState = () => Object.keys(STORAGE_KEYS).forEach(k=>localStorage.setItem(STORAGE_KEYS[k],JSON.stringify(state[k])));
const updateEntity = (ent,data) => {
  const idx = state[ent].findIndex(i=>i.id===data.id);
  if(idx>-1) state[ent][idx]={...state[ent][idx],...data};
  else state[ent].push({id:uuid(),createdAt:new Date().toISOString(),...data});
  saveState(); renderActiveTab();
};
const deleteEntity = (ent,id) => { state[ent]=state[ent].filter(i=>i.id!==id); saveState(); renderActiveTab(); };

/* ==================== NAVIGATION ==================== */
const renderActiveTab = () => {
  const tab = document.querySelector('.nav-link.active').dataset.tab;
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.getElementById(tab).classList.add('active');

  const fns = {
    dashboard: renderDashboard,
    companies: ()=>renderCompanies(),
    customers: ()=>renderCompanies(true),
    contacts: renderContacts,
    orders: renderOrderList,
    tasks: renderTaskList,
    cases: renderCaseList,
    calendar: renderCalendar,
    reports: renderReports
  };
  fns[tab]();
};
const setupNavigation = () => {
  document.querySelectorAll('.nav-link').forEach(l=>{
    l.addEventListener('click',e=>{
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active'));
      l.classList.add('active');
      renderActiveTab();
    });
  });
};

/* ==================== MODAL HELPERS ==================== */
const modal = () => document.getElementById('universalModal');
const title = () => document.getElementById('modal-title');
const formArea = () => document.getElementById('modal-form-area');
const openUniversalModal = (t,html)=>{ title().textContent=t; formArea().innerHTML=html; modal().classList.add('active'); };
const closeUniversalModal = ()=>{ modal().classList.remove('active'); renderActiveTab(); };
window.closeUniversalModal = closeUniversalModal;

/* ==================== REPORTS ==================== */
window.setReportType = t=>{
  activeReportType=t;
  document.querySelectorAll('#report-buttons .report-btn').forEach(b=>{
    b.classList.remove('bg-blue-600','text-white');
    b.classList.add('bg-gray-200','hover:bg-gray-300');
  });
  document.querySelector(`#report-buttons button[onclick="setReportType('${t}')"]`)
    .classList.add('bg-blue-600','text-white')
    .classList.remove('bg-gray-200','hover:bg-gray-300');
  renderReports();
};
const renderReports = ()=>{
  const out=document.getElementById('report-output');
  let html='';
  if(activeReportType==='tasks') html=renderTaskReport();
  else if(activeReportType==='sales') html=renderSalesReports();
  else if(activeReportType==='inventory') html=renderInventoryReport();
  else if(activeReportType==='pickleball') html=renderPickleballReport();
  out.innerHTML=html;
};
const renderTaskReport = ()=>{
  const total=state.tasks.length, done=state.tasks.filter(t=>t.status==='Complete').length,
        overdue=state.tasks.filter(t=>isOverdue(t.dueDate,t.status)).length;
  return `<h4 class="text-xl font-bold mb-4">Task Productivity Summary</h4>
          <table class="w-full text-left table-auto"><thead class="bg-gray-100"><tr><th class="p-3">Metric</th><th class="p-3">Value</th></tr></thead>
          <tbody><tr><td class="p-3 border-t">Total Tasks</td><td class="p-3 border-t">${total}</td></tr>
          <tr><td class="p-3 border-t">Completed</td><td class="p-3 border-t font-bold text-green-600">${done}</td></tr>
          <tr><td class="p-3 border-t">Overdue</td><td class="p-3 border-t font-bold text-red-600">${overdue}</td></tr></tbody></table>`;
};
const renderSalesReports = ()=>{
  const calc = p=>{
    const now=new Date(), start=new Date(now);
    if(p==='daily') start.setHours(0,0,0,0);
    else if(p==='weekly'){ start.setDate(now.getDate()-now.getDay()); start.setHours(0,0,0,0); }
    else if(p==='monthly'){ start.setDate(1); start.setHours(0,0,0,0); }
    return state.orders.filter(o=>new Date(o.orderDate)>=start && o.status==='Delivered')
                      .reduce((s,o)=>s+o.total,0);
  };
  return `<h4 class="text-xl font-bold mb-4">Delivered Sales Volume</h4>
          <div class="grid grid-cols-3 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-600">Today</p><p class="text-2xl font-bold">${formatCurrency(calc('daily'))}</p></div>
            <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-600">This Week</p><p class="text-2xl font-bold">${formatCurrency(calc('weekly'))}</p></div>
            <div class="bg-blue-50 p-4 rounded-lg"><p class="text-sm text-gray-600">This Month</p><p class="text-2xl font-bold">${formatCurrency(calc('monthly'))}</p></div>
          </div>`;
};
const renderInventoryReport = ()=>`
  <h4 class="text-xl font-bold mb-4">Inventory Status</h4>
  <ul class="space-y-2">${state.inventory.map(p=>`
    <li class="flex justify-between p-3 border rounded-lg ${p.availableQty<=10?'bg-red-100 text-red-700':'bg-gray-50'}">
      <span>${p.name} (${p.id})</span>
      <span class="font-bold">Available: ${p.availableQty}</span>
    </li>`).join('')}</ul>`;
const renderPickleballReport = ()=>{
  const clubs = state.contacts.reduce((a,c)=>{ const k=c.pickleballClub||'Unaffiliated'; a[k]=(a[k]||0)+1; return a; },{});
  const total = state.contacts.length;
  return `<h4 class="text-xl font-bold mb-4">Pickleball Club Segmentation</h4>
          <table class="w-full text-left table-auto"><thead class="bg-gray-100"><tr><th class="p-3">Club</th><th class="p-3">Count</th><th class="p-3">% of Contacts</th></tr></thead>
          <tbody>${Object.entries(clubs).map(([k,v])=>`
            <tr><td class="p-3 border-t">${k}</td><td class="p-3 border-t">${v}</td>
                <td class="p-3 border-t">${total?((v/total)*100).toFixed(1):0}%</td></tr>`).join('')}</tbody></table>`;
};

/* ==================== CALENDAR ==================== */
window.changeCalendarDate = d=>{ currentCalendarDate.setDate(currentCalendarDate.getDate()+d); renderCalendar(); };
window.setCalendarViewMode = m=>{ calendarViewMode=m; renderCalendar(); };
const renderCalendar = ()=>{ renderCalendarControls(); const c=document.getElementById('calendar-view-container');
  calendarViewMode==='daily'? renderDailySchedule(c) : c.innerHTML=`<p class="p-4">${calendarViewMode.toUpperCase()} view – use Daily for full schedule.</p>`; };
const renderCalendarControls = ()=>{
  const ctrl=document.getElementById('calendar-controls');
  ctrl.innerHTML=`
    <div class="space-x-2">
      <button onclick="setCalendarViewMode('daily')" class="px-4 py-2 text-sm rounded-lg ${calendarViewMode==='daily'?'bg-blue-600 text-white':'bg-gray-200 hover:bg-gray-300'}">Daily</button>
      <button onclick="setCalendarViewMode('weekly')" class="px-4 py-2 text-sm rounded-lg ${calendarViewMode==='weekly'?'bg-blue-600 text-white':'bg-gray-200 hover:bg-gray-300'}">Weekly</button>
      <button onclick="setCalendarViewMode('monthly')" class="px-4 py-2 text-sm rounded-lg ${calendarViewMode==='monthly'?'bg-blue-600 text-white':'bg-gray-200 hover:bg-gray-300'}">Monthly</button>
    </div>
    <div class="space-x-2">
      <button onclick="changeCalendarDate(${calendarViewMode==='monthly'?-30:-1})" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">Prev</button>
      <span class="font-semibold text-gray-700">${currentCalendarDate.toLocaleDateString()}</span>
      <button onclick="changeCalendarDate(${calendarViewMode==='monthly'?30:1})" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">Next</button>
    </div>`;
};
const renderDailySchedule = c=>{
  const dateStr = currentCalendarDate.toISOString().slice(0,10);
  const appts = state.appointments.filter(a=>a.date.startsWith(dateStr));
  let html=`<div class="p-4"><h3 class="text-xl font-semibold mb-4">Daily Schedule – ${currentCalendarDate.toLocaleDateString()}</h3>
            <button onclick="openScheduleModal('${dateStr}T09:00:00')" class="px-3 py-1 bg-green-600 text-white rounded-lg mb-4">+ Add Appointment</button>
            <table class="w-full text-left border-collapse">`;
  for(let h=6;h<=20;h++){
    const slot=`${dateStr}T${String(h).padStart(2,'0')}:00:00`;
    const a=appts.find(x=>x.date===slot);
    const time=new Date(slot).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    html+=`<tr onclick="openScheduleModal('${slot}')" class="cursor-pointer hover:bg-gray-100 border-b">
              <td class="w-24 font-bold p-2">${time}</td>
              <td class="p-2 ${a?'bg-blue-50 text-blue-800':'text-gray-400'}">
                  ${a?`**${a.title}** (${a.note||'No notes'})`:'Click to schedule'}
              </td></tr>`;
  }
  html+='</table></div>'; c.innerHTML=html;
};
window.openScheduleModal = d=>{
  const ex=state.appointments.find(a=>a.date===d);
  const title=prompt(`Appointment at ${new Date(d).toLocaleTimeString()}: Title`,ex?ex.title:'')||'';
  if(!title && ex){ if(confirm('Delete?')) deleteEntity('appointments',ex.id); return; }
  if(!title) return;
  const note=prompt('Notes:',ex?ex.note:'')||'';
  updateEntity('appointments',{id:ex?ex.id:uuid(),date:d,title,note});
};

/* ==================== TASKS ==================== */
const renderTaskList = ()=>{
  const cont=document.getElementById('task-list-container');
  const sorted=[...state.tasks].sort((a,b)=>{
    const p={High:3,Medium:2,Low:1};
    const oa=isOverdue(a.dueDate,a.status)?1:0, ob=isOverdue(b.dueDate,b.status)?1:0;
    if(oa!==ob) return ob-oa;
    if(p[b.priority]!==p[a.priority]) return p[b.priority]-p[a.priority];
    return new Date(a.dueDate)-new Date(b.dueDate);
  });
  cont.innerHTML=sorted.map(t=>{
    const ov=isOverdue(t.dueDate,t.status);
    const col=t.status==='Complete'?'border-green-500':ov?'border-red-500':t.priority==='High'?'border-yellow-500':'border-blue-500';
    const bg=t.status==='Complete'?'bg-green-50':ov?'bg-red-50':'bg-white';
    const rel=t.relatedType?`${t.relatedType}: ${t.relatedId}`:'General';
    return `<div class="${bg} p-4 rounded-xl shadow-sm border-l-4 ${col} flex justify-between items-center list-item">
                <div><p class="text-lg font-semibold text-gray-800">${t.title} <span class="text-sm text-gray-600">(${t.status})</span></p>
                     <p class="text-sm text-gray-500">Due: <strong>${formatDate(t.dueDate)}</strong> | Priority: ${t.priority} | ${rel}</p></div>
                <div class="flex space-x-3">
                  <select onchange="updateTaskStatus('${t.id}',this.value)" class="p-2 border rounded-lg text-sm bg-white">
                    ${['Open','In Progress','Complete'].map(s=>`<option value="${s}" ${t.status===s?'selected':''}>${s}</option>`).join('')}
                  </select>
                  <button onclick="openTaskModal('${t.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                </div>
              </div>`;
  }).join('')||'<p class="p-4 bg-white rounded-lg">No tasks.</p>';
};
window.updateTaskStatus = (id,s)=>updateEntity('tasks',{id,status:s});

/* ==================== CASES ==================== */
const renderCaseList = ()=>{
  const cont=document.getElementById('case-list-container');
  const sorted=[...state.cases].sort((a,b)=> ({High:3,Medium:2,Low:1}[b.priority] - {High:3,Medium:2,Low:1}[a.priority]) );
  cont.innerHTML=sorted.map(c=>{
    const con=state.contacts.find(x=>x.id===c.contactId);
    const col=c.status==='Resolved'||c.status==='Closed'?'border-green-500':c.status==='Open'?'border-red-500':'border-yellow-500';
    return `<div class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${col} flex justify-between items-center list-item">
                <div><p class="text-lg font-semibold text-gray-800">${c.subject}</p>
                     <p class="text-sm text-gray-500">Customer: ${con?con.firstName+' '+con.lastName:'N/A'} | Agent: ${c.agentId}</p>
                     <p class="text-xs text-gray-500">Opened: ${formatDateTime(c.timeOpened)} | Priority: ${c.priority}</p></div>
                <div class="flex space-x-3">
                  <span class="text-sm font-medium px-3 py-1 rounded-full ${c.status==='Open'?'bg-red-500':'bg-blue-500'} text-white">${c.status}</span>
                  <button onclick="openCaseModal('${c.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                </div>
              </div>`;
  }).join('')||'<p class="p-4 bg-white rounded-lg">No cases.</p>';
};

/* ==================== DASHBOARD ==================== */
const renderDashboard = ()=>{
  const cust=state.companies.filter(c=>c.status==='Customer').length;
  const openT=state.tasks.filter(t=>t.status!=='Complete').length;
  const rev=state.orders.reduce((s,o)=>s+o.total,0);
  const openC=state.cases.filter(c=>c.status!=='Closed'&&c.status!=='Resolved').length;
  document.getElementById('dashboard-stats').innerHTML=`
    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-600"><p class="text-sm text-gray-500">Customers</p><h3 class="text-3xl font-bold text-blue-600">${cust}</h3></div>
    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600"><p class="text-sm text-gray-500">Revenue</p><h3 class="text-3xl font-bold text-green-600">${formatCurrency(rev)}</h3></div>
    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500"><p class="text-sm text-gray-500">Open Tasks</p><h3 class="text-3xl font-bold text-yellow-500">${openT}</h3></div>
    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-red-600"><p class="text-sm text-gray-500">Open Cases</p><h3 class="text-3xl font-bold text-red-600">${openC}</h3></div>`;
  const ov=state.tasks.filter(t=>isOverdue(t.dueDate,t.status));
  const list=document.getElementById('overdue-tasks-list');
  list.innerHTML=ov.map(t=>`<li class="p-3 bg-red-50 border border-red-200 rounded-lg flex justify-between items-center">
      <div><p class="font-medium text-red-700">${t.title}</p><p class="text-sm text-red-500">Due: ${formatDate(t.dueDate)}</p></div>
      <button onclick="openTaskModal('${t.id}')" class="text-red-700 hover:text-red-900 text-sm font-medium">Edit</button></li>`).join('')
      || '<p class="text-gray-500">No overdue tasks.</p>';
};

/* ==================== COMPANIES / CUSTOMERS ==================== */
const renderCompanies = (custOnly=false)=>{
  const cont = custOnly ? document.getElementById('customer-list') : document.getElementById('company-list');
  let list = state.companies;
  if(custOnly) list=list.filter(c=>c.status==='Customer');
  const sorted=[...list].sort((a,b)=>a.name.localeCompare(b.name));
  cont.innerHTML=sorted.map(c=>`
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center list-item">
      <div><p class="text-lg font-semibold text-gray-800">${c.name}
          <span class="text-xs font-medium px-2 py-1 rounded-full ml-2 ${c.status==='Customer'?'bg-green-100 text-green-700':'bg-gray-100 text-gray-700'}">${c.status}</span>
          <span class="text-xs font-medium px-2 py-1 rounded-full ml-2 bg-yellow-100 text-yellow-700">${c.customerTier||'None'}</span></p>
      <p class="text-sm text-gray-500">Owner: ${c.owner||'N/A'} | Revenue: ${formatCurrency(c.revenue)}</p></div>
      <button onclick="openCompanyModal('${c.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 rounded-lg border border-blue-600 hover:border-blue-800 transition">Edit</button>
    </div>`).join('')||'<p class="p-4 bg-white rounded-lg">No records.</p>';
};

/* ==================== CONTACTS ==================== */
const renderContacts = ()=>{
  const cont=document.getElementById('contact-list');
  const sorted=[...state.contacts].sort((a,b)=>a.lastName.localeCompare(b.lastName));
  cont.innerHTML=sorted.map(c=>{
    const comp=state.companies.find(x=>x.id===c.companyId)?.name||'Unassigned';
    return `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center list-item">
      <div><p class="text-lg font-semibold text-gray-800">${c.lastName}, ${c.firstName} <span class="text-sm text-gray-600">(${c.jobTitle||'N/A'})</span></p>
           <p class="text-sm text-gray-500">Company: ${comp} | Mobile: ${c.mobile||'N/A'}</p>
           ${c.pickleballClub?`<p class="text-xs font-medium text-purple-600 mt-1">Pickleball Club: ${c.pickleballClub}</p>`:''}</div>
      <div class="flex space-x-2">
        <button onclick="openCaseModal(null,'${c.id}')" class="px-3 py-1 bg-yellow-500 text-white text-sm font-medium rounded-lg hover:bg-yellow-600 transition">New Case</button>
        <button onclick="openContactModal('${c.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 rounded-lg border border-blue-600 hover:border-blue-800 transition">Edit</button>
      </div>
    </div>`;
  }).join('')||'<p class="p-4 bg-white rounded-lg">No contacts.</p>';
};

/* ==================== ORDERS ==================== */
const renderOrderList = ()=>{
  const cont=document.getElementById('order-list');
  if(state.orders.length===0){
    cont.innerHTML='<p class="p-4 bg-white rounded-lg">No orders yet. Click “New Phone Order” to add one.</p>'; return;
  }
  const sorted=[...state.orders].sort((a,b)=>new Date(b.orderDate)-new Date(a.orderDate));
  cont.innerHTML=sorted.map(o=>{
    const cust=state.companies.find(c=>c.id===o.companyId);
    const statusCol=o.status==='Delivered'?'bg-green-100 text-green-700':o.status==='Shipped'?'bg-blue-100 text-blue-700':'bg-yellow-100 text-yellow-700';
    return `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center list-item">
      <div><p class="text-lg font-semibold text-gray-800">#${o.id.slice(0,6)} – ${cust?.name||'N/A'}</p>
           <p class="text-sm text-gray-500">Date: ${formatDate(o.orderDate)} | Total: ${formatCurrency(o.total)}</p></div>
      <div class="flex space-x-2">
        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusCol}">${o.status}</span>
        <button onclick="openOrderEntryModal('${o.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
      </div>
    </div>`;
  }).join('');
};

/* ==================== MODAL IMPLEMENTATIONS ==================== */
window.openCompanyModal = (id=null)=>{
  const comp = id?state.companies.find(c=>c.id===id):{};
  const html=`
    <form onsubmit="event.preventDefault(); saveCompany(this, '${id||''}');">
      <div class="grid grid-cols-2 gap-4">
        <input type="text" placeholder="Company Name" value="${comp.name||''}" required class="p-2 border rounded">
        <select class="p-2 border rounded"><option ${comp.status==='Customer'?'selected':''}>Customer</option><option ${comp.status==='Prospect'?'selected':''}>Prospect</option></select>
        <input type="text" placeholder="Tier (Gold/Silver)" value="${comp.customerTier||''}" class="p-2 border rounded">
        <input type="number" placeholder="Annual Revenue" value="${comp.revenue||''}" class="p-2 border rounded">
        <input type="text" placeholder="Owner" value="${comp.owner||''}" class="p-2 border rounded">
      </div>
      <div class="mt-4 flex justify-end space-x-2">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button>
        <button type="button" onclick="closeUniversalModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
      </div>
    </form>`;
  openUniversalModal(id?'Edit Company':'Add Company',html);
};
window.saveCompany = (form,id)=>{
  const i=form.querySelectorAll('input,select');
  const data={name:i[0].value,status:i[1].value,customerTier:i[2].value,revenue:+i[3].value,owner:i[4].value};
  updateEntity('companies', id?{id,...data}:{...data});
  closeUniversalModal();
};

window.openContactModal = (id=null)=>{
  const con = id?state.contacts.find(c=>c.id===id):{};
  const compOpts=state.companies.map(c=>`<option value="${c.id}" ${c.id===con.companyId?'selected':''}>${c.name}</option>`).join('');
  const html=`
    <form onsubmit="event.preventDefault(); saveContact(this, '${id||''}');">
      <div class="grid grid-cols-2 gap-4">
        <input type="text" placeholder="First Name" value="${con.firstName||''}" required class="p-2 border rounded">
        <input type="text" placeholder="Last Name" value="${con.lastName||''}" required class="p-2 border rounded">
        <select class="p-2 border rounded">${compOpts}</select>
        <input type="text" placeholder="Job Title" value="${con.jobTitle||''}" class="p-2 border rounded">
        <input type="email" placeholder="Email" value="${con.email||''}" class="p-2 border rounded">
        <input type="text" placeholder="Mobile" value="${con.mobile||''}" class="p-2 border rounded">
        <input type="text" placeholder="Pickleball Club" value="${con.pickleballClub||''}" class="p-2 border rounded">
      </div>
      <div class="mt-4 flex justify-end space-x-2">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button>
        <button type="button" onclick="closeUniversalModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
      </div>
    </form>`;
  openUniversalModal(id?'Edit Contact':'Add Contact',html);
};
window.saveContact = (form,id)=>{
  const i=form.querySelectorAll('input,select');
  const data={firstName:i[0].value,lastName:i[1].value,companyId:i[2].value,jobTitle:i[3].value,
              email:i[4].value,mobile:i[5].value,pickleballClub:i[6].value};
  updateEntity('contacts', id?{id,...data}:{...data});
  closeUniversalModal();
};

window.openTaskModal = (id=null)=>{
  const t = id?state.tasks.find(x=>x.id===id):{};
  const relOpts=state.companies.map(c=>`<option value="${c.id}" ${c.id===t.relatedId?'selected':''}>${c.name}</option>`).join('');
  const html=`
    <form onsubmit="event.preventDefault(); saveTask(this, '${id||''}');">
      <input type="text" placeholder="Task Title" value="${t.title||''}" required class="w-full p-2 border rounded mb-3">
      <input type="date" value="${t.dueDate||''}" required class="w-full p-2 border rounded mb-3">
      <select class="w-full p-2 border rounded mb-3"><option ${t.priority==='High'?'selected':''}>High</option><option ${t.priority==='Medium'?'selected':''}>Medium</option><option ${t.priority==='Low'?'selected':''}>Low</option></select>
      <select class="w-full p-2 border rounded mb-3"><option>Company</option>${relOpts}</select>
      <textarea placeholder="Notes" class="w-full p-2 border rounded mb-3">${t.notes||''}</textarea>
      <div class="flex justify-end space-x-2">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save</button>
        <button type="button" onclick="closeUniversalModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
      </div>
    </form>`;
  openUniversalModal(id?'Edit Task':'Add Task',html);
};
window.saveTask = (f,id)=>{
  const i=f.querySelectorAll('input,select,textarea');
  const data={title:i[0].value,dueDate:i[1].value,priority:i[2].value,
              relatedType:'Company',relatedId:i[3].value,notes:i[4].value,status:id?state.tasks.find(x=>x.id===id).status:'Open'};
  updateEntity('tasks', id?{id,...data}:{...data});
  closeUniversalModal();
};

window.openCaseModal = (id=null,contactId=null)=>{
  const c = id?state.cases.find(x=>x.id===id):{};
  const conOpts=state.contacts.map(x=>`<option value="${x.id}" ${x.id===c.contactId?'selected':''}>${x.firstName} ${x.lastName}</option>`).join('');
  const html=`
    <form onsubmit="event.preventDefault(); saveCase(this, '${id||''}');">
      <input type="text" placeholder="Subject" value="${c.subject||''}" required class="w-full p-2 border rounded mb-3">
      <select class="w-full p-2 border rounded mb-3">${conOpts}</select>
      <select class="w-full p-2 border rounded mb-3"><option ${c.priority==='High'?'selected':''}>High</option><option ${c.priority==='Medium'?'selected':''}>Medium</option><option ${c.priority==='Low'?'selected':''}>Low</option></select>
      <textarea placeholder="Description" class="w-full p-2 border rounded mb-3">${c.description||''}</textarea>
      <div class="flex justify-end space-x-2">
        <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-lg">Save</button>
        <button type="button" onclick="closeUniversalModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
      </div>
    </form>`;
  openUniversalModal(id?'Edit Case':'New Case',html);
};
window.saveCase = (f,id)=>{
  const i=f.querySelectorAll('input,select,textarea');
  const data={subject:i[0].value,contactId:i[1].value,priority:i[2].value,description:i[3].value,
              status:id?state.cases.find(x=>x.id===id).status:'Open',agentId:'JT101',
              timeOpened:id?state.cases.find(x=>x.id===id).timeOpened:new Date().toISOString()};
  updateEntity('cases', id?{id,...data}:{...data});
  closeUniversalModal();
};

window.openOrderEntryModal = (id=null)=>{
  const o = id?state.orders.find(x=>x.id===id):{};
  const compOpts=state.companies.map(c=>`<option value="${c.id}" ${c.id===o.companyId?'selected':''}>${c.name}</option>`).join('');
  const prodOpts=state.inventory.map(p=>`<option value="${p.id}" data-price="${p.unitPrice}">${p.name} – $${p.unitPrice}</option>`).join('');
  const html=`
    <form onsubmit="event.preventDefault(); saveOrder(this, '${id||''}');">
      <select class="w-full p-2 border rounded mb-3">${compOpts}</select>
      <div id="order-lines" class="space-y-2 mb-3"></div>
      <button type="button" onclick="addOrderLine(this.form)" class="px-3 py-1 bg-gray-300 rounded mb-3">+ Add Product</button>
      <div class="flex justify-end space-x-2">
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg">Save Order</button>
        <button type="button" onclick="closeUniversalModal()" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
      </div>
    </form>`;
  openUniversalModal(id?'Edit Order':'New Order',html);
  if(id) (o.lines||[]).forEach(l=>addOrderLine(document.querySelector('#order-lines').closest('form'),l));
  else addOrderLine(document.querySelector('#order-lines').closest('form'));
};
const addOrderLine = (form,line={})=>{
  const div=document.createElement('div'); div.className='flex space-x-2 items-center';
  div.innerHTML=`
    <select class="flex-1 p-2 border rounded" onchange="calcOrderTotal(this.form)">
      ${state.inventory.map(p=>`<option value="${p.id}" data-price="${p.unitPrice}" ${p.id===line.productId?'selected':''}>${p.name}</option>`).join('')}
    </select>
    <input type="number" min="1" value="${line.qty||1}" class="w-20 p-2 border rounded" onchange="calcOrderTotal(this.form)">
    <button type="button" onclick="this.parentElement.remove(); calcOrderTotal(this.form)" class="text-red-600">Remove</button>`;
  form.querySelector('#order-lines').appendChild(div);
  calcOrderTotal(form);
};
const calcOrderTotal = form=>{
  let total=0;
  form.querySelectorAll('#order-lines > div').forEach(d=>{
    const sel=d.querySelector('select'), qty=+d.querySelector('input').value;
    total+=sel.selectedOptions[0].dataset.price*qty;
  });
};
window.saveOrder = (f,id)=>{
  const companyId=f.querySelector('select').value;
  const lines=Array.from(f.querySelectorAll('#order-lines > div')).map(d=>({
    productId:d.querySelector('select').value,
    qty:+d.querySelector('input').value
  }));
  const total=lines.reduce((s,l)=>s+state.inventory.find(p=>p.id===l.productId).unitPrice*l.qty,0);
  const data={companyId,lines,total,orderDate:new Date().toISOString().slice(0,10),status:'Pending'};
  updateEntity('orders', id?{id,...data}:{...data});
  closeUniversalModal();
};

/* ==================== EXPORT ==================== */
window.exportData = ()=>{
  const data=JSON.stringify(state,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='acoustiskin_crm.json'; a.click();
  URL.revokeObjectURL(url);
};

/* ==================== INIT ==================== */
document.addEventListener('DOMContentLoaded',()=>{ loadState(); setupNavigation(); renderActiveTab(); });
</script>
</body>
</html>
