<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcoustiSkin CRM - Master Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1e293b; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }

        /* Layout */
        .sidebar { width: 280px; background: #1e1b4b; color: white; display: flex; flex-direction: column; height: 100vh; transition: all 0.3s; flex-shrink: 0; }
        .main-content { flex: 1; height: 100vh; overflow-y: auto; padding: 24px; position: relative; }
        
        /* Navigation Items */
        .nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; color: #a5b4fc; transition: all 0.2s; border-left: 4px solid transparent; font-size: 0.95rem; }
        .nav-item:hover { background: #312e81; color: white; }
        .nav-item.active { background: #4338ca; color: white; border-left-color: #818cf8; font-weight: 600; }
        .nav-icon { width: 25px; text-align: center; margin-right: 12px; }

        /* Module Cards */
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .stat-card { border-left: 5px solid; }

        /* Kanban Board */
        .kanban-container { display: flex; gap: 16px; overflow-x: auto; height: calc(100vh - 140px); padding-bottom: 10px; }
        .kanban-col { min-width: 300px; background: #f1f5f9; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; }
        .kanban-card { background: white; padding: 16px; margin-bottom: 12px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: grab; border-top: 4px solid #6366f1; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 50; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideDown 0.3s ease-out; }
        
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Address Book List */
        .addr-item { padding: 8px 12px; cursor: pointer; border-radius: 6px; margin-bottom: 2px; font-size: 0.9rem; color: #e0e7ff; }
        .addr-item:hover { background: #4338ca; color: white; }
    </style>
</head>
<body class="flex overflow-hidden">

    <aside class="sidebar shadow-2xl">
        <div class="p-6 flex items-center gap-3 border-b border-indigo-900 bg-indigo-950">
            <div class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">AS</div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">AcoustiSkin</h1>
                <div class="text-xs text-indigo-300 font-medium tracking-wider uppercase">CRM Suite</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-4">
            
            <div class="px-6 mb-2 text-xs font-bold text-indigo-400 uppercase tracking-wider mt-2">Core Modules</div>
            <div id="nav-dashboard" class="nav-item active" onclick="switchView('dashboard')"><i class="fa-solid fa-chart-pie nav-icon"></i> Dashboard</div>
            <div id="nav-customers" class="nav-item" onclick="switchView('customers')"><i class="fa-solid fa-users nav-icon"></i> Customers</div>
            <div id="nav-new-order" class="nav-item" onclick="switchView('new-order')"><i class="fa-solid fa-cart-plus nav-icon"></i> New Order</div>
            <div id="nav-order-tracking" class="nav-item" onclick="switchView('order-tracking')"><i class="fa-solid fa-truck-fast nav-icon"></i> Order Tracking</div>
            <div id="nav-calendar" class="nav-item" onclick="switchView('calendar')"><i class="fa-regular fa-calendar-days nav-icon"></i> Calendar</div>
            <div id="nav-pipeline" class="nav-item" onclick="switchView('pipeline')"><i class="fa-solid fa-filter nav-icon"></i> Pipeline</div>
            <div id="nav-reports" class="nav-item" onclick="switchView('reports')"><i class="fa-solid fa-chart-line nav-icon"></i> Reports</div>
            <div id="nav-vendors" class="nav-item" onclick="switchView('vendors')"><i class="fa-solid fa-briefcase nav-icon"></i> Vendors & Team</div>

            <div class="px-6 mt-8 mb-3 text-xs font-bold text-indigo-400 uppercase tracking-wider">Quick Actions</div>
            <div class="px-4 space-y-2">
                <button onclick="openModal('customer')" class="w-full text-left px-4 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white text-sm rounded-lg transition shadow flex items-center gap-3 font-medium">
                    <i class="fa-solid fa-plus"></i> New Customer
                </button>
                <button onclick="openModal('vendor')" class="w-full text-left px-4 py-2.5 bg-indigo-800 hover:bg-indigo-700 text-indigo-100 text-sm rounded-lg transition flex items-center gap-3 font-medium">
                    <i class="fa-solid fa-building"></i> New Vendor
                </button>
                <button onclick="openModal('task')" class="w-full text-left px-4 py-2.5 bg-indigo-900 hover:bg-indigo-800 text-indigo-200 text-sm rounded-lg transition flex items-center gap-3 font-medium">
                    <i class="fa-solid fa-clock"></i> Quick Schedule Task
                </button>
            </div>

            <div class="px-6 mt-8 mb-3 text-xs font-bold text-indigo-400 uppercase tracking-wider">Data Tools</div>
            <div class="px-4 flex gap-2 mb-6">
                <button onclick="exportData()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-2 rounded text-slate-200 font-medium transition">
                    <i class="fa-solid fa-download mr-1"></i> Export Data
                </button>
                <label class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-2 rounded text-slate-200 font-medium text-center cursor-pointer transition">
                    <i class="fa-solid fa-upload mr-1"></i> Import Data
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                </label>
            </div>
        </div>

        <div class="p-4 bg-indigo-950 border-t border-indigo-900">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-indigo-400 uppercase">ADDRESS BOOK</span>
                <button onclick="resetSystem()" class="text-[10px] bg-red-900 text-red-200 px-2 py-0.5 rounded hover:bg-red-700">Reset System Data</button>
            </div>
            <div class="relative">
                <i class="fa-solid fa-search absolute left-3 top-2.5 text-indigo-400 text-xs"></i>
                <input type="text" id="addrSearch" onkeyup="filterAddressBook()" placeholder="Find customer..." class="w-full bg-indigo-900 border border-indigo-800 text-white text-sm rounded pl-8 pr-3 py-2 focus:ring-1 focus:ring-indigo-500 outline-none placeholder-indigo-400">
            </div>
            <div id="addressBookList" class="h-32 overflow-y-auto mt-2 pr-1 custom-scroll">
                </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="flex justify-between items-center mb-8 sticky top-0 bg-[#f3f4f6] py-2 z-10 backdrop-blur-sm bg-opacity-90">
            <div>
                <h2 id="pageTitle" class="text-3xl font-bold text-slate-800">Dashboard</h2>
                <p id="pageSubtitle" class="text-slate-500 text-sm mt-1">Overview of your business performance</p>
            </div>
            <div class="flex items-center gap-4">
                <div id="contextBadge" class="hidden items-center bg-white px-4 py-2 rounded-full shadow-sm border border-indigo-100">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                    <span class="text-xs text-gray-500 mr-1">Active:</span>
                    <span id="contextName" class="text-sm font-bold text-indigo-700">Customer Name</span>
                    <button onclick="clearContext()" class="ml-3 text-gray-400 hover:text-red-500"><i class="fa-solid fa-circle-xmark"></i></button>
                </div>
                <div class="h-10 w-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-md border-2 border-white">DL</div>
            </div>
        </header>

        <div id="viewContainer" class="animate-fade-in">
            </div>
    </main>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-box">
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Title</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // === DATA STORE ===
        let db = {
            customers: [],
            vendors: [],
            orders: [],
            tasks: [],
            pipeline: [],
            activeContextId: null
        };

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const saved = localStorage.getItem('acoustiskin_crm_v2');
                if (saved) {
                    db = JSON.parse(saved);
                    // Basic integrity check
                    if (!Array.isArray(db.customers)) throw new Error("Corrupt Data");
                } else {
                    seedData();
                }
            } catch (e) {
                console.error("Data load failed, resetting.", e);
                seedData();
            }
            
            // Initial Render
            refreshAddressBook();
            updateContextBadge();
            switchView('dashboard');
        });

        function seedData() {
            db = {
                customers: [
                    { id: 'c1', name: 'Pickleball Kingdom', email: 'buyer@pbkingdom.com', phone: '555-0199', status: 'Active', type: 'Wholesale' },
                    { id: 'c2', name: 'Dana Lurie', email: 'dana@test.com', phone: '555-0100', status: 'Active', type: 'Internal' },
                    { id: 'c3', name: 'Courtside Pro Shop', email: 'info@courtside.com', phone: '555-0123', status: 'Prospect', type: 'Retail' }
                ],
                vendors: [
                    { id: 'v1', name: '3M Supplies', contact: 'Jim', type: 'Materials' },
                    { id: 'v2', name: 'FedEx', contact: 'Support', type: 'Shipping' }
                ],
                orders: [
                    { id: 'ORD-8821', customerId: 'c1', customerName: 'Pickleball Kingdom', date: '2023-10-24', total: 1250.00, status: 'Shipped' },
                    { id: 'ORD-8822', customerId: 'c3', customerName: 'Courtside Pro Shop', date: '2023-11-15', total: 89.95, status: 'Processing' }
                ],
                tasks: [
                    { id: 't1', title: 'Follow up on invoice #8821', date: new Date().toISOString().split('T')[0], type: 'Email' }
                ],
                pipeline: [
                    { id: 'p1', title: 'Holiday Bulk Order', customer: 'Pickleball Kingdom', value: 5000, stage: 'Negotiation' },
                    { id: 'p2', title: 'New Franchise Deal', customer: 'Courtside Pro Shop', value: 12000, stage: 'Lead' }
                ],
                activeContextId: null
            };
            saveData();
        }

        function saveData() {
            localStorage.setItem('acoustiskin_crm_v2', JSON.stringify(db));
            refreshAddressBook();
            updateContextBadge();
        }

        function resetSystem() {
            if(confirm("WARNING: This will delete all data and reset the system to factory defaults. Are you sure?")) {
                localStorage.removeItem('acoustiskin_crm_v2');
                location.reload();
            }
        }

        // === NAVIGATION LOGIC ===
        function switchView(viewName) {
            // Update Sidebar UI
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById('nav-' + viewName);
            if(activeNav) activeNav.classList.add('active');

            const container = document.getElementById('viewContainer');
            const title = document.getElementById('pageTitle');
            const sub = document.getElementById('pageSubtitle');

            // Router
            switch(viewName) {
                case 'dashboard':
                    title.innerText = "Dashboard";
                    sub.innerText = "Real-time business overview";
                    renderDashboard(container);
                    break;
                case 'customers':
                    title.innerText = "Customer Database";
                    sub.innerText = "Manage your clients and leads";
                    renderCustomers(container);
                    break;
                case 'new-order':
                    title.innerText = "New Order";
                    sub.innerText = "Create a new sales order";
                    renderNewOrder(container);
                    break;
                case 'order-tracking':
                    title.innerText = "Order Tracking";
                    sub.innerText = "Monitor shipment status";
                    renderOrderTracking(container);
                    break;
                case 'calendar':
                    title.innerText = "Calendar & Tasks";
                    sub.innerText = "Schedule and to-do list";
                    renderCalendar(container);
                    break;
                case 'pipeline':
                    title.innerText = "Sales Pipeline";
                    sub.innerText = "Drag and drop deal management";
                    renderPipeline(container);
                    break;
                case 'reports':
                    title.innerText = "Reports";
                    sub.innerText = "Analytics and performance metrics";
                    renderReports(container);
                    break;
                case 'vendors':
                    title.innerText = "Vendors & Team";
                    sub.innerText = "Manage suppliers and staff";
                    renderVendors(container);
                    break;
            }
        }

        // === RENDERERS ===

        function renderDashboard(target) {
            const totalRev = db.orders.reduce((acc, o) => acc + o.total, 0);
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card stat-card border-indigo-500 py-4">
                        <div class="text-gray-500 text-xs font-bold uppercase mb-1">Total Revenue</div>
                        <div class="text-2xl font-bold text-indigo-700">$${totalRev.toLocaleString()}</div>
                    </div>
                    <div class="card stat-card border-green-500 py-4">
                        <div class="text-gray-500 text-xs font-bold uppercase mb-1">Active Customers</div>
                        <div class="text-2xl font-bold text-green-700">${db.customers.length}</div>
                    </div>
                    <div class="card stat-card border-blue-500 py-4">
                        <div class="text-gray-500 text-xs font-bold uppercase mb-1">Pipeline Value</div>
                        <div class="text-2xl font-bold text-blue-700">$${db.pipeline.reduce((a,b)=>a+b.value,0).toLocaleString()}</div>
                    </div>
                    <div class="card stat-card border-orange-500 py-4">
                        <div class="text-gray-500 text-xs font-bold uppercase mb-1">Pending Tasks</div>
                        <div class="text-2xl font-bold text-orange-700">${db.tasks.length}</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card h-full">
                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Recent Activity</h3>
                        <div class="space-y-4">
                            ${db.orders.slice(0, 3).map(o => `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm text-gray-800">Order #${o.id}</div>
                                        <div class="text-xs text-gray-500">${o.customerName}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-indigo-600">$${o.total}</div>
                                        <div class="text-[10px] px-2 py-0.5 rounded bg-green-100 text-green-700 inline-block">${o.status}</div>
                                    </div>
                                </div>
                            `).join('')}
                            ${db.orders.length === 0 ? '<p class="text-gray-400 text-sm">No recent activity.</p>' : ''}
                        </div>
                    </div>
                    <div class="bg-indigo-900 rounded-xl p-6 text-white shadow-lg">
                        <h3 class="font-bold mb-2 text-lg">System Status</h3>
                        <p class="text-indigo-200 text-sm mb-4">All modules are active. Data is saving locally.</p>
                        <button onclick="switchView('new-order')" class="w-full py-3 bg-white text-indigo-900 font-bold rounded-lg hover:bg-indigo-50 transition shadow">
                            <i class="fa-solid fa-plus mr-2"></i> Create Quick Order
                        </button>
                    </div>
                </div>
            `;
        }

        function renderCustomers(target) {
            target.innerHTML = `
                <div class="card overflow-hidden p-0">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                            <tr><th class="p-4">Name</th><th class="p-4">Contact</th><th class="p-4">Type</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${db.customers.map(c => `
                                <tr class="hover:bg-indigo-50 transition group">
                                    <td class="p-4 font-bold text-indigo-900 cursor-pointer" onclick="setContext('${c.id}')">${c.name}</td>
                                    <td class="p-4 text-gray-600">${c.email}<br><span class="text-xs text-gray-400">${c.phone}</span></td>
                                    <td class="p-4 text-gray-600">${c.type}</td>
                                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${c.status==='Active'?'bg-green-100 text-green-700':'bg-gray-100 text-gray-500'}">${c.status}</span></td>
                                    <td class="p-4 text-right">
                                        <button onclick="setContext('${c.id}'); switchView('new-order')" class="text-indigo-600 hover:text-indigo-900 font-medium text-xs mr-3">Order</button>
                                        <button onclick="setContext('${c.id}')" class="text-gray-400 hover:text-indigo-600"><i class="fa-solid fa-arrow-right"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNewOrder(target) {
            const activeC = db.customers.find(c => c.id === db.activeContextId);
            if(!activeC) {
                target.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <div class="bg-indigo-100 p-4 rounded-full text-indigo-600 mb-4"><i class="fa-solid fa-user-slash fa-2xl"></i></div>
                        <h3 class="text-lg font-bold text-gray-700">No Customer Selected</h3>
                        <p class="text-gray-500 mb-4 max-w-md">Please select a customer from the "Customers" tab or the Address Book sidebar to create an order for them.</p>
                        <button onclick="switchView('customers')" class="bg-indigo-600 text-white px-6 py-2 rounded font-medium">Go to Customers</button>
                    </div>`;
                return;
            }
            
            target.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="card border-t-4 border-indigo-600">
                        <div class="flex justify-between border-b pb-4 mb-6">
                            <div>
                                <div class="text-xs text-gray-500 uppercase font-bold">Bill To</div>
                                <h2 class="text-xl font-bold text-gray-800">${activeC.name}</h2>
                                <p class="text-sm text-gray-500">${activeC.email}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 uppercase font-bold">Order Date</div>
                                <div class="text-xl font-bold text-gray-800">${new Date().toLocaleDateString()}</div>
                            </div>
                        </div>

                        <form id="orderForm" onsubmit="submitOrder(event)">
                            <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                                <h4 class="font-bold text-sm text-gray-700 mb-3 uppercase">Line Items</h4>
                                <div class="grid grid-cols-12 gap-4 mb-2 text-xs font-bold text-gray-500 uppercase">
                                    <div class="col-span-6">Product</div>
                                    <div class="col-span-2">Qty</div>
                                    <div class="col-span-3">Price</div>
                                </div>
                                <div class="grid grid-cols-12 gap-4 items-center mb-4">
                                    <div class="col-span-6">
                                        <select name="product" class="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                            <option value="29.95">AcoustiSkin Standard ($29.95)</option>
                                            <option value="35.00">AcoustiSkin Custom ($35.00)</option>
                                            <option value="15.00">Overgrip 3-Pack ($15.00)</option>
                                            <option value="150.00">Wholesale Pack 10x ($150.00)</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <input type="number" name="qty" value="1" min="1" class="w-full p-2 border rounded bg-white">
                                    </div>
                                    <div class="col-span-3">
                                        <input type="text" value="Calculated at checkout" disabled class="w-full p-2 bg-gray-100 rounded text-gray-500 text-xs">
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center mt-6">
                                <div class="text-sm text-gray-500">Status set to: <span class="font-bold text-gray-700">Processing</span></div>
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95">
                                    <i class="fa-solid fa-check mr-2"></i> Confirm Order
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderOrderTracking(target) {
            target.innerHTML = `
                <div class="card p-0 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                            <tr><th class="p-4">Order ID</th><th class="p-4">Customer</th><th class="p-4">Date</th><th class="p-4">Total</th><th class="p-4">Status</th></tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${db.orders.map(o => `
                                <tr>
                                    <td class="p-4 font-mono font-bold text-indigo-600">#${o.id}</td>
                                    <td class="p-4 font-medium text-gray-800">${o.customerName}</td>
                                    <td class="p-4 text-gray-500">${o.date}</td>
                                    <td class="p-4 font-bold">$${o.total.toFixed(2)}</td>
                                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${o.status==='Shipped'?'bg-blue-100 text-blue-700':o.status==='Processing'?'bg-yellow-100 text-yellow-700':'bg-green-100 text-green-700'}">${o.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        function renderCalendar(target) {
            const today = new Date().toISOString().split('T')[0];
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                    <div class="card md:col-span-2 flex flex-col h-full">
                        <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2"><i class="fa-regular fa-calendar-check text-indigo-500"></i> Upcoming Agenda</h3>
                        <div class="flex-1 overflow-y-auto space-y-3 pr-2">
                            ${db.tasks.length === 0 ? '<div class="text-center py-10 text-gray-400">No tasks scheduled.</div>' : ''}
                            ${db.tasks.map(t => `
                                <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition bg-white shadow-sm group">
                                    <div class="w-1 h-10 bg-indigo-500 rounded-full mr-4"></div>
                                    <div class="flex-1">
                                        <div class="font-bold text-gray-800">${t.title}</div>
                                        <div class="text-xs text-gray-500 flex gap-3 mt-1">
                                            <span><i class="fa-regular fa-clock mr-1"></i> ${t.date}</span>
                                            <span class="uppercase font-bold text-indigo-400">${t.type}</span>
                                        </div>
                                    </div>
                                    <button onclick="deleteTask('${t.id}')" class="text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <div class="card bg-indigo-900 text-white mb-4">
                            <h3 class="font-bold mb-4"><i class="fa-solid fa-plus mr-2"></i> Quick Add</h3>
                            <form onsubmit="createTask(event)">
                                <input type="text" name="title" placeholder="Task Title..." class="w-full p-2 mb-3 rounded bg-indigo-800 text-white placeholder-indigo-400 border-none focus:ring-2 focus:ring-indigo-400 text-sm" required>
                                <input type="date" name="date" value="${today}" class="w-full p-2 mb-3 rounded bg-indigo-800 text-white border-none text-sm" required>
                                <select name="type" class="w-full p-2 mb-4 rounded bg-indigo-800 text-white border-none text-sm">
                                    <option>Call</option><option>Meeting</option><option>Email</option><option>Todo</option>
                                </select>
                                <button type="submit" class="w-full bg-white text-indigo-900 py-2 rounded font-bold text-sm hover:bg-indigo-50">Add Task</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPipeline(target) {
            const stages = ['Lead', 'Negotiation', 'Closed Won'];
            target.innerHTML = `
                <div class="kanban-container">
                    ${stages.map(stage => `
                        <div class="kanban-col shadow-inner">
                            <div class="flex justify-between items-center mb-3 px-1">
                                <h4 class="font-bold text-xs text-gray-500 uppercase tracking-wider">${stage}</h4>
                                <span class="bg-gray-200 text-gray-600 text-xs font-bold px-2 py-0.5 rounded-full">${db.pipeline.filter(p=>p.stage===stage).length}</span>
                            </div>
                            <div class="space-y-2 overflow-y-auto flex-1 pr-1 custom-scroll">
                                ${db.pipeline.filter(p => p.stage === stage).map(d => `
                                    <div class="kanban-card group">
                                        <div class="font-bold text-sm text-gray-800">${d.title}</div>
                                        <div class="text-xs text-gray-500 mt-1 mb-2">${d.customer}</div>
                                        <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                                            <span class="font-bold text-indigo-600 text-xs">$${d.value.toLocaleString()}</span>
                                            <div class="opacity-0 group-hover:opacity-100 transition">
                                                ${stage !== 'Closed Won' ? `<button onclick="moveStage('${d.id}', 'Closed Won')" class="text-green-500 hover:text-green-700 text-xs mr-2" title="Mark Won"><i class="fa-solid fa-check"></i></button>` : ''}
                                                <button onclick="deleteDeal('${d.id}')" class="text-gray-400 hover:text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderReports(target) {
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold text-lg text-gray-800 mb-6">Revenue Overview</h3>
                        <div class="flex items-end h-48 gap-4 px-4 border-b border-l border-gray-300 pb-2">
                            <div class="w-1/5 bg-indigo-200 h-[40%] rounded-t relative group hover:bg-indigo-300 transition"></div>
                            <div class="w-1/5 bg-indigo-300 h-[55%] rounded-t relative group hover:bg-indigo-400 transition"></div>
                            <div class="w-1/5 bg-indigo-400 h-[30%] rounded-t relative group hover:bg-indigo-500 transition"></div>
                            <div class="w-1/5 bg-indigo-600 h-[85%] rounded-t relative group hover:bg-indigo-700 transition"><div class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-indigo-700">$1.2k</div></div>
                            <div class="w-1/5 bg-gray-100 h-[10%] rounded-t relative group"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2 px-6">
                            <span>Jul</span><span>Aug</span><span>Sep</span><span>Oct</span><span>Nov</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-lg text-gray-800 mb-6">Top Performance</h3>
                        <div class="space-y-4">
                            ${db.customers.slice(0, 4).map((c, i) => `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full bg-gray-100 text-xs font-bold flex items-center justify-center text-gray-500">${i+1}</div>
                                        <span class="text-sm font-medium text-gray-700">${c.name}</span>
                                    </div>
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-green-500" style="width: ${Math.max(20, 100 - (i*20))}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVendors(target) {
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold text-gray-800 mb-4 flex justify-between items-center">
                            <span>Vendors</span>
                            <button onclick="openModal('vendor')" class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-200">+ Add</button>
                        </h3>
                        <div class="space-y-3">
                            ${db.vendors.map(v => `
                                <div class="flex justify-between items-center p-3 border rounded hover:bg-gray-50">
                                    <div>
                                        <div class="font-bold text-sm text-gray-800">${v.name}</div>
                                        <div class="text-xs text-gray-500">${v.type} â€¢ ${v.contact}</div>
                                    </div>
                                    <i class="fa-solid fa-building text-gray-300"></i>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-gray-800 mb-4">Internal Team</h3>
                        <div class="space-y-3">
                             <div class="flex items-center gap-3 p-3 border rounded bg-indigo-50 border-indigo-100">
                                <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">DL</div>
                                <div>
                                    <div class="font-bold text-sm text-gray-800">Dana Lurie</div>
                                    <div class="text-xs text-indigo-600 font-bold">Owner / Admin</div>
                                </div>
                             </div>
                             <div class="flex items-center gap-3 p-3 border rounded">
                                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold">A</div>
                                <div>
                                    <div class="font-bold text-sm text-gray-800">Allyson</div>
                                    <div class="text-xs text-gray-500">Affiliate Manager</div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // === LOGIC ACTIONS ===

        // Context (Active Customer)
        function setContext(id) {
            db.activeContextId = id;
            saveData();
            updateContextBadge();
            // Visual feedback
            document.querySelectorAll('.addr-item').forEach(i => i.classList.remove('bg-indigo-600'));
            const el = document.getElementById('addr-'+id);
            if(el) el.classList.add('bg-indigo-600');
        }

        function clearContext() {
            db.activeContextId = null;
            saveData();
            updateContextBadge();
        }

        function updateContextBadge() {
            const badge = document.getElementById('contextBadge');
            const nameEl = document.getElementById('contextName');
            if(db.activeContextId) {
                const c = db.customers.find(x => x.id === db.activeContextId);
                if(c) {
                    nameEl.innerText = c.name;
                    badge.classList.remove('hidden');
                    badge.classList.add('flex');
                    return;
                }
            }
            badge.classList.add('hidden');
            badge.classList.remove('flex');
        }

        // Address Book
        function refreshAddressBook() {
            const list = document.getElementById('addressBookList');
            list.innerHTML = db.customers.map(c => `
                <div id="addr-${c.id}" onclick="setContext('${c.id}')" class="addr-item ${db.activeContextId===c.id?'bg-indigo-600 text-white':''}">
                    <div class="font-medium">${c.name}</div>
                </div>
            `).join('');
        }

        function filterAddressBook() {
            const term = document.getElementById('addrSearch').value.toLowerCase();
            const items = document.querySelectorAll('.addr-item');
            items.forEach(item => {
                const txt = item.innerText.toLowerCase();
                item.style.display = txt.includes(term) ? 'block' : 'none';
            });
        }

        // Modals
        function openModal(type) {
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            overlay.style.display = 'flex';

            if(type === 'customer') {
                title.innerText = "Add New Customer";
                content.innerHTML = `
                    <form onsubmit="addCustomer(event)" class="space-y-4">
                        <div><label class="text-xs font-bold text-gray-500">Company Name</label><input name="name" class="w-full border p-2 rounded mt-1" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">Email</label><input name="email" type="email" class="w-full border p-2 rounded mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-500">Phone</label><input name="phone" class="w-full border p-2 rounded mt-1"></div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500">Type</label><select name="type" class="w-full border p-2 rounded mt-1"><option>Wholesale</option><option>Retail</option></select></div>
                        <button class="w-full bg-indigo-600 text-white font-bold py-3 rounded mt-2">Save Customer</button>
                    </form>
                `;
            } else if (type === 'vendor') {
                title.innerText = "Add New Vendor";
                content.innerHTML = `
                     <form onsubmit="addVendor(event)" class="space-y-4">
                        <div><label class="text-xs font-bold text-gray-500">Vendor Name</label><input name="name" class="w-full border p-2 rounded mt-1" required></div>
                        <div><label class="text-xs font-bold text-gray-500">Service Type</label><input name="type" class="w-full border p-2 rounded mt-1" placeholder="e.g. Logistics"></div>
                        <div><label class="text-xs font-bold text-gray-500">Contact Person</label><input name="contact" class="w-full border p-2 rounded mt-1"></div>
                        <button class="w-full bg-indigo-800 text-white font-bold py-3 rounded mt-2">Save Vendor</button>
                    </form>
                `;
            } else if (type === 'task') {
                title.innerText = "Quick Task";
                content.innerHTML = `
                     <form onsubmit="createTask(event)" class="space-y-4">
                        <div><label class="text-xs font-bold text-gray-500">Description</label><input name="title" class="w-full border p-2 rounded mt-1" required></div>
                        <div><label class="text-xs font-bold text-gray-500">Date</label><input type="date" name="date" class="w-full border p-2 rounded mt-1" required></div>
                        <div><label class="text-xs font-bold text-gray-500">Type</label><select name="type" class="w-full border p-2 rounded mt-1"><option>Call</option><option>Meeting</option></select></div>
                        <button class="w-full bg-indigo-900 text-white font-bold py-3 rounded mt-2">Save Task</button>
                    </form>
                `;
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        // Form Handlers
        function addCustomer(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            const id = 'c' + Date.now();
            db.customers.push({
                id: id,
                name: f.get('name'),
                email: f.get('email'),
                phone: f.get('phone'),
                type: f.get('type'),
                status: 'Prospect'
            });
            setContext(id); // Auto select new customer
            saveData();
            closeModal();
            switchView('customers');
        }

        function addVendor(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            db.vendors.push({
                id: 'v' + Date.now(),
                name: f.get('name'),
                type: f.get('type'),
                contact: f.get('contact')
            });
            saveData();
            closeModal();
            switchView('vendors');
        }

        function createTask(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            db.tasks.push({
                id: 't' + Date.now(),
                title: f.get('title'),
                date: f.get('date'),
                type: f.get('type')
            });
            saveData();
            closeModal();
            switchView('calendar');
        }

        function submitOrder(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            const qty = parseInt(f.get('qty'));
            const price = parseFloat(f.get('product'));
            const activeC = db.customers.find(c => c.id === db.activeContextId);
            
            db.orders.unshift({
                id: 'ORD-' + Math.floor(Math.random() * 9000 + 1000),
                customerId: activeC.id,
                customerName: activeC.name,
                date: new Date().toISOString().split('T')[0],
                total: qty * price,
                status: 'Processing'
            });
            saveData();
            alert("Order Created Successfully!");
            switchView('order-tracking');
        }

        // Deletions & Moves
        function deleteTask(id) {
            if(confirm("Delete task?")) {
                db.tasks = db.tasks.filter(t => t.id !== id);
                saveData();
                renderCalendar(document.getElementById('viewContainer'));
            }
        }

        function deleteDeal(id) {
            if(confirm("Delete deal?")) {
                db.pipeline = db.pipeline.filter(p => p.id !== id);
                saveData();
                renderPipeline(document.getElementById('viewContainer'));
            }
        }

        function moveStage(id, stage) {
            const deal = db.pipeline.find(p => p.id === id);
            if(deal) {
                deal.stage = stage;
                saveData();
                renderPipeline(document.getElementById('viewContainer'));
            }
        }

        // Export / Import
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "acoustiskin_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(confirm("This will overwrite your current data. Continue?")) {
                        db = imported;
                        saveData();
                        location.reload();
                    }
                } catch(err) {
                    alert("Invalid file format.");
                }
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>
