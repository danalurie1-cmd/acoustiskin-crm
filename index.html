<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AcoustiSkin CRM (V17 – Full Order Form)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#1a2a44; --secondary:#0070e0; --accent:#27ae60; --danger:#e74c3c; }
    body { font-family:'Inter',sans-serif; background:#f4f6f9; }
    .sidebar { background:#2c3e50; }
    .nav-link { border-left:4px solid transparent; display:block; padding:8px 12px; margin-bottom:4px; color:#d1d5db; }
    .nav-link:hover { background:#004b9940; }
    .nav-link.active { background:#004b99 !important; border-left-color:var(--secondary)!important; color:white!important; }
    .content { display:none; }
    .content.active { display:block; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:50; justify-content:center; align-items:center; }
    .modal.active { display:flex; }
    .modal-content { max-width:1000px; max-height:95vh; overflow-y:auto; }
    .list-item { transition:all .2s; }
    .list-item:hover { transform:translateY(-2px); box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .search-results { max-height:200px; overflow-y:auto; border:1px solid #ddd; background:white; }
    .search-result:hover { background:#f0f0f0; cursor:pointer; }
  </style>
</head>
<body class="h-screen flex flex-col">

<header class="bg-[#1a2a44] text-white p-3 flex justify-between items-center shadow-lg">
  <h1 class="text-xl font-semibold">AcoustiSkin CRM V17</h1>
  <button onclick="exportData()" class="px-3 py-1 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition text-sm font-medium">
    Export Data JSON
  </button>
</header>

<div class="flex flex-1 overflow-hidden">
  <!-- Sidebar -->
  <div class="w-60 bg-[#2c3e50] text-white p-4 flex flex-col space-y-6 sidebar">
    <div class="text-xl font-bold text-white uppercase">AcoustiSkin V17</div>
    <nav class="space-y-1" id="sidebar-nav">
      <a href="#" class="nav-link active font-medium" data-tab="dashboard">Dashboard</a>
      <a href="#" class="nav-link font-medium" data-tab="companies">Companies (All)</a>
      <a href="#" class="nav-link font-medium" data-tab="customers">Customers</a>
      <a href="#" class="nav-link font-medium" data-tab="contacts">Contacts</a>
      <a href="#" class="nav-link font-medium" data-tab="orders">Order Entry & Tracking</a>
      <a href="#" class="nav-link font-medium" data-tab="tasks">To-Do List / Tasks</a>
      <a href="#" class="nav-link font-medium" data-tab="cases">Case Management</a>
      <a href="#" class="nav-link font-medium" data-tab="calendar">Calendar & Appointments</a>
      <a href="#" class="nav-link font-medium" data-tab="reports">Reports</a>
    </nav>
  </div>

  <!-- Main Content -->
  <main class="flex-1 p-6 bg-gray-50 overflow-y-auto" id="main-content-area">

    <!-- DASHBOARD -->
    <div id="dashboard" class="content active">
      <div class="bg-white p-6 rounded-xl shadow-md space-y-6">
        <h2 class="text-2xl font-bold text-gray-800">Sales Overview</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-stats"></div>
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
          <h3 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Urgent: Overdue Tasks</h3>
          <ul class="space-y-3" id="overdue-tasks-list"></ul>
        </div>
      </div>
    </div>

    <!-- ORDERS -->
    <div id="orders" class="content">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Tracking & History</h2>
      <button onclick="openOrderEntryModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition mb-4">New Phone Order</button>
      <div id="order-list" class="space-y-3"></div>
    </div>

    <!-- (Other tabs: companies, customers, contacts, tasks, cases, calendar, reports) -->
    <!-- Omitted for brevity – include from previous working version -->

  </main>
</div>

<!-- UNIVERSAL MODAL -->
<div id="universalModal" class="modal">
  <div class="bg-white rounded-xl shadow-2xl w-full modal-content p-6">
    <div class="flex justify-between items-center pb-4 border-b">
      <h2 class="text-xl font-semibold text-gray-800" id="modal-title">Modal Title</h2>
      <button onclick="closeUniversalModal()" class="text-gray-400 hover:text-gray-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="modal-form-area"></div>
  </div>
</div>

<script>
/* ==================== GLOBAL STATE ==================== */
let state = {
  companies: [], contacts: [], tasks: [], appointments: [], orders: [],
  inventory: [
    {id:'PBA-001',name:'AcoustiSkin Classic',availableQty:100,unitPrice:19.99},
    {id:'PBA-002',name:'AcoustiSkin Pro',availableQty:50,unitPrice:29.99}
  ],
  cases: []
};

/* ==================== UTILITIES ==================== */
const STORAGE_KEYS = { companies:'crm_companies', contacts:'crm_contacts', orders:'crm_orders', inventory:'crm_inventory' };
const uuid = () => Math.random().toString(36).substring(2,9);
const formatCurrency = a => `$${Number(a||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`;

/* ==================== STORAGE ==================== */
const loadState = () => {
  Object.keys(STORAGE_KEYS).forEach(k=>{
    const s = localStorage.getItem(STORAGE_KEYS[k]);
    if(s) try{ state[k]=JSON.parse(s); }catch(e){}
    else if(k==='inventory') state[k]=[
      {id:'PBA-001',name:'AcoustiSkin Classic',availableQty:100,unitPrice:19.99},
      {id:'PBA-002',name:'AcoustiSkin Pro',availableQty:50,unitPrice:29.99}
    ];
    else state[k]=[];
  });
  if(state.companies.length===0){
    const cid=uuid();
    state.companies.push({id:cid,name:'Alpha Sound Systems',status:'Customer',revenue:50000,owner:'Admin'});
    state.contacts.push({id:uuid(),firstName:'Jane',lastName:'Doe',companyId:cid,email:'jane@alpha.com',phone:'555-0001'});
  }
  saveState();
};
const saveState = () => Object.keys(STORAGE_KEYS).forEach(k=>localStorage.setItem(STORAGE_KEYS[k],JSON.stringify(state[k])));
const updateEntity = (ent,data) => {
  const idx = state[ent].findIndex(i=>i.id===data.id);
  if(idx>-1) state[ent][idx]={...state[ent][idx],...data};
  else state[ent].push({id:uuid(),createdAt:new Date().toISOString(),...data});
  saveState(); renderActiveTab();
};

/* ==================== NAVIGATION ==================== */
const renderActiveTab = () => {
  const tab = document.querySelector('.nav-link.active')?.dataset.tab;
  if (!tab) return;
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('auto'));
  const el = document.getElementById(tab);
  if (el) el.classList.add('active');
  if(tab==='orders') renderOrderList();
};
const setupNavigation = () => {
  document.querySelectorAll('.nav-link').forEach(l=>{
    l.addEventListener('click',e=>{
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active'));
      l.classList.add('active');
      renderActiveTab();
    });
  });
};

/* ==================== ORDER LIST ==================== */
const renderOrderList = () => {
  const cont = document.getElementById('order-list');
  if(state.orders.length===0){
    cont.innerHTML='<p class="p-4 bg-white rounded-lg">No orders yet.</p>'; return;
  }
  cont.innerHTML = state.orders.map(o => {
    const cust = state.companies.find(c=>c.id===o.customerId) || {};
    return `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 list-item">
      <p class="font-semibold">#${o.id.slice(0,6)} – ${cust.name||'N/A'}</p>
      <p class="text-sm text-gray-600">Total: ${formatCurrency(o.total)} | Status: ${o.status}</p>
      <button onclick="openOrderEntryModal('${o.id}')" class="text-blue-600 text-sm">Edit</button>
    </div>`;
  }).join('');
};

/* ==================== FULL ORDER ENTRY MODAL ==================== */
window.openOrderEntryModal = (id = null) => {
  const order = id ? state.orders.find(o => o.id === id) : {};
  const isEdit = !!id;

  let html = `
    <form onsubmit="event.preventDefault(); saveOrder(this, '${id||''}');" class="space-y-6">
      
      <!-- 1. CUSTOMER & ACCOUNT INFO -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-bold text-lg mb-3">1. Customer & Account Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Search Customer (Name/Email/Phone)</label>
            <input type="text" id="customer-search" placeholder="Type to search..." class="w-full p-2 border rounded mt-1" oninput="searchCustomers(this.value)">
            <div id="search-results" class="search-results mt-1"></div>
          </div>
          <div>
            <label class="block text-sm font-medium">Agent Name/ID</label>
            <input type="text" value="Agent JT101" readonly class="w-full p-2 border rounded bg-gray-100 mt-1">
          </div>
          <div>
            <label class="block text-sm font-medium">Order Source</label>
            <select class="w-full p-2 border rounded mt-1">
              <option>Phone Order</option>
              <option>Customer Service</option>
              <option>Walk-in</option>
            </select>
          </div>
        </div>
        <div id="customer-info" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- 2. PRODUCT & ORDER DETAILS -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-bold text-lg mb-3">2. Product & Order Details</h3>
        <div class="flex gap-2 mb-3">
          <input type="text" id="product-search" placeholder="Search SKU or Name..." class="flex-1 p-2 border rounded" oninput="searchProducts(this.value)">
          <button type="button" onclick="addProductToCart()" class="px-4 py-2 bg-blue-600 text-white rounded">Add</button>
        </div>
        <div id="cart-items" class="space-y-2 mb-4"></div>
        <div class="flex justify-between font-semibold">
          <span>Subtotal:</span> <span id="subtotal">$0.00</span>
        </div>
        <div class="flex gap-2">
          <input type="text" placeholder="Discount Code" class="flex-1 p-2 border rounded">
          <button type="button" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm">Apply</button>
        </div>
        <div class="mt-2">
          <label><input type="checkbox"> Gift Wrap (+$5.00)</label>
          <input type="text" placeholder="Gift Message" class="ml-4 p-1 border rounded text-sm">
        </div>
      </div>

      <!-- 3. SHIPPING & FULFILLMENT -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-bold text-lg mb-3">3. Shipping & Fulfillment</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" placeholder="Recipient Name" required class="p-2 border rounded">
          <input type="text" placeholder="Street Address" required class="p-2 border rounded">
          <input type="text" placeholder="City" required class="p-2 border rounded">
          <input type="text" placeholder="State/Province" required class="p-2 border rounded">
          <input type="text" placeholder="Zip/Postal Code" required class="p-2 border rounded">
          <input type="text" placeholder="Country" value="USA" required class="p-2 border rounded">
        </div>
        <div class="mt-3">
          <label class="block font-medium">Shipping Method</label>
          <select class="w-full p-2 border rounded mt-1" onchange="updateShippingCost(this.value)">
            <option value="5.99">Standard (3-5 days) – $5.99</option>
            <option value="12.99">Expedited (2 days) – $12.99</option>
            <option value="29.99">Next Day – $29.99</option>
          </select>
        </div>
        <div class="mt-2 text-right font-semibold">
          Shipping: <span id="shipping-cost">$5.99</span>
        </div>
        <textarea placeholder="Internal Fulfillment Notes" class="w-full p-2 border rounded mt-3"></textarea>
      </div>

      <!-- 4. PAYMENT & FINALIZATION -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-bold text-lg mb-3">4. Payment & Finalization</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium">Payment Method</label>
            <select class="w-full p-2 border rounded mt-1">
              <option>Credit Card</option>
              <option>Debit Card</option>
              <option>Gift Card</option>
              <option>Account Credit</option>
            </select>
          </div>
          <div>
            <label><input type="checkbox" checked> Same as Shipping Address</label>
          </div>
        </div>
        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-300 rounded">
          <p class="text-sm"><strong>Secure Payment:</strong> Use PCI-compliant gateway. Card details not stored.</p>
        </div>
        <div class="mt-4 flex justify-between items-center font-bold text-lg">
          <span>Total Charged:</span>
          <span id="final-total">$0.00</span>
        </div>
        <div class="mt-4">
          <label><input type="checkbox" required> I confirm I have customer authorization to charge.</label>
        </div>
      </div>

      <div class="flex justify-end space-x-3 mt-6">
        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium">Save Order</button>
        <button type="button" onclick="closeUniversalModal()" class="px-6 py-2 bg-gray-300 rounded-lg">Cancel</button>
      </div>
    </form>`;

  openUniversalModal(isEdit ? 'Edit Order' : 'New Assisted Order', html);
  if (isEdit) loadOrderIntoForm(order);
  else initNewOrderForm();
};

/* ==================== ORDER FORM LOGIC ==================== */
let currentCart = [];
let selectedCustomer = null;

const initNewOrderForm = () => {
  currentCart = [];
  selectedCustomer = null;
  updateCartDisplay();
  updateTotals();
};

const searchCustomers = (query) => {
  const results = document.getElementById('search-results');
  if (!query.trim()) { results.innerHTML = ''; return; }
  const matches = state.contacts.filter(c => 
    c.firstName.toLowerCase().includes(query.toLowerCase()) ||
    c.lastName.toLowerCase().includes(query.toLowerCase()) ||
    c.email.toLowerCase().includes(query.toLowerCase()) ||
    c.phone.includes(query)
  ).slice(0, 5);
  results.innerHTML = matches.map(c => `
    <div class="p-2 search-result" onclick="selectCustomer('${c.id}')">
      ${c.firstName} ${c.lastName} – ${c.email} (${c.phone})
    </div>`).join('') || '<div class="p-2 text-gray-500">No matches</div>';
};

window.selectCustomer = (contactId) => {
  selectedCustomer = state.contacts.find(c => c.id === contactId);
  const company = state.companies.find(co => co.id === selectedCustomer.companyId) || {};
  document.getElementById('customer-search').value = `${selectedCustomer.firstName} ${selectedCustomer.lastName}`;
  document.getElementById('search-results').innerHTML = '';
  document.getElementById('customer-info').innerHTML = `
    <div><strong>Company:</strong> ${company.name || 'N/A'}</div>
    <div><strong>Email:</strong> ${selectedCustomer.email}</div>
    <div><strong>Phone:</strong> ${selectedCustomer.phone}</div>
    <div><strong>Shipping Address:</strong> Use saved address</div>`;
};

const searchProducts = (query) => {
  const results = document.createElement('div');
  results.className = 'absolute bg-white border mt-1 w-full z-10 max-h-48 overflow-y-auto';
  if (!query.trim()) { document.body.appendChild(results); return; }
  const matches = state.inventory.filter(p => 
    p.id.toLowerCase().includes(query.toLowerCase()) ||
    p.name.toLowerCase().includes(query.toLowerCase())
  );
  results.innerHTML = matches.map(p => `
    <div class="p-2 hover:bg-gray-100 cursor-pointer" onclick="selectProduct('${p.id}')">
      [${p.id}] ${p.name} – $${p.unitPrice} (Stock: ${p.availableQty})
    </div>`).join('');
  document.getElementById('product-search').parentNode.appendChild(results);
};

window.selectProduct = (productId) => {
  const product = state.inventory.find(p => p.id === productId);
  currentCart.push({ productId, qty: 1, price: product.unitPrice });
  updateCartDisplay();
  updateTotals();
  document.getElementById('product-search').value = '';
  document.querySelectorAll('.absolute').forEach(el => el.remove());
};

const updateCartDisplay = () => {
  const container = document.getElementById('cart-items');
  container.innerHTML = currentCart.map((item, i) => {
    const prod = state.inventory.find(p => p.id === item.productId);
    return `<div class="flex items-center gap-2 p-2 bg-white border rounded">
      <span class="flex-1">${prod.name}</span>
      <input type="number" min="1" value="${item.qty}" class="w-16 p-1 border rounded" onchange="updateQty(${i}, this.value)">
      <span>× $${item.price}</span>
      <button type="button" onclick="removeFromCart(${i})" class="text-red-600">×</button>
    </div>`;
  }).join('') || '<p class="text-gray-500">No items in cart</p>';
};

window.updateQty = (index, qty) => {
  currentCart[index].qty = parseInt(qty) || 1;
  updateTotals();
};
window.removeFromCart = (index) => {
  currentCart.splice(index, 1);
  updateCartDisplay();
  updateTotals();
};

const updateTotals = () => {
  const subtotal = currentCart.reduce((sum, item) => sum + item.price * item.qty, 0);
  const shipping = parseFloat(document.querySelector('[onchange="updateShippingCost"]').value) || 5.99;
  const total = subtotal + shipping;
  document.getElementById('subtotal').textContent = formatCurrency(subtotal);
  document.getElementById('final-total').textContent = formatCurrency(total);
};

window.updateShippingCost = (cost) => {
  document.getElementById('shipping-cost').textContent = formatCurrency(cost);
  updateTotals();
};

window.saveOrder = (form, id) => {
  const order = {
    id: id || uuid(),
    customerId: selectedCustomer?.companyId,
    contactId: selectedCustomer?.id,
    items: currentCart,
    subtotal: currentCart.reduce((s,i)=>s+i.price*i.qty,0),
    shippingCost: parseFloat(form.querySelector('[onchange="updateShippingCost"]').value),
    total: currentCart.reduce((s,i)=>s+i.price*i.qty,0) + parseFloat(form.querySelector('[onchange="updateShippingCost"]').value),
    status: 'Pending',
    orderDate: new Date().toISOString(),
    agentId: 'JT101',
    source: form.querySelector('select').value,
    notes: form.querySelector('textarea').value
  };
  updateEntity('orders', order);
  closeUniversalModal();
};

/* ==================== INIT ==================== */
document.addEventListener('DOMContentLoaded', () => {
  loadState();
  setupNavigation();
  renderActiveTab();
});
</script>
</body>
</html>
