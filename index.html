<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcoustiSkin CRM - Master Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- GLOBAL STYLES --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            color: #1e293b; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 280px; 
            background: #1e1b4b; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            flex-shrink: 0; 
            transition: all 0.3s ease;
        }
        
        /* Navigation Items */
        .nav-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            color: #a5b4fc; 
            transition: all 0.2s; 
            border-left: 4px solid transparent; 
            font-size: 0.95rem;
        }
        .nav-item:hover { 
            background: #312e81; 
            color: white; 
        }
        .nav-item.active { 
            background: #4338ca; 
            color: white; 
            border-left-color: #818cf8; 
            font-weight: 600; 
        }
        .nav-icon { 
            width: 25px; 
            text-align: center; 
            margin-right: 12px; 
        }
        .section-header {
            padding: 20px 24px 8px 24px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #818cf8;
        }

        /* --- MAIN CONTENT --- */
        .main-content { 
            flex: 1; 
            height: 100vh; 
            overflow-y: auto; 
            padding: 24px; 
            position: relative; 
        }

        /* --- CARDS & CONTAINERS --- */
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 24px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            border: 1px solid #e2e8f0; 
            margin-bottom: 20px; 
        }
        .stat-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* --- KANBAN BOARD --- */
        .kanban-container { 
            display: flex; 
            gap: 16px; 
            overflow-x: auto; 
            height: calc(100vh - 180px); 
            padding-bottom: 10px; 
        }
        .kanban-col { 
            min-width: 320px; 
            background: #f1f5f9; 
            border-radius: 8px; 
            padding: 12px; 
            display: flex; 
            flex-direction: column; 
            height: 100%;
        }
        .kanban-card { 
            background: white; 
            padding: 16px; 
            margin-bottom: 12px; 
            border-radius: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            cursor: grab; 
            border-top: 4px solid #6366f1; 
            transition: transform 0.1s;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- MODALS --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 50; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(3px); 
        }
        .modal-box { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 95%; 
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { 
            from { transform: translateY(-20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }

        /* --- ADDRESS BOOK --- */
        .addr-item { 
            padding: 10px 16px; 
            cursor: pointer; 
            border-radius: 6px; 
            margin-bottom: 4px; 
            font-size: 0.9rem; 
            color: #e0e7ff; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .addr-item:hover { 
            background: #312e81; 
            color: white; 
        }
        .addr-item.active-ctx {
            background: #4f46e5;
            color: white;
            font-weight: bold;
        }
        
        /* Utility */
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex"><aside class="sidebar shadow-2xl">
        <div class="p-6 flex items-center gap-3 border-b border-indigo-900 bg-indigo-950">
            <div class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">AS</div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">AcoustiSkin</h1>
                <div class="text-xs text-indigo-300 font-medium tracking-wider uppercase">CRM Suite</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-2 custom-scroll">
            
            <div class="section-header">Core Modules</div>
            <div id="nav-dashboard" class="nav-item active" onclick="switchView('dashboard')"><i class="fa-solid fa-chart-pie nav-icon"></i> Dashboard</div>
            <div id="nav-customers" class="nav-item" onclick="switchView('customers')"><i class="fa-solid fa-users nav-icon"></i> Customers</div>
            <div id="nav-new-order" class="nav-item" onclick="switchView('new-order')"><i class="fa-solid fa-cart-plus nav-icon"></i> New Order</div>
            <div id="nav-order-tracking" class="nav-item" onclick="switchView('order-tracking')"><i class="fa-solid fa-truck-fast nav-icon"></i> Order Tracking</div>
            <div id="nav-calendar" class="nav-item" onclick="switchView('calendar')"><i class="fa-regular fa-calendar-days nav-icon"></i> Calendar</div>
            <div id="nav-pipeline" class="nav-item" onclick="switchView('pipeline')"><i class="fa-solid fa-filter nav-icon"></i> Pipeline</div>
            <div id="nav-reports" class="nav-item" onclick="switchView('reports')"><i class="fa-solid fa-chart-line nav-icon"></i> Reports</div>
            <div id="nav-vendors" class="nav-item" onclick="switchView('vendors')"><i class="fa-solid fa-briefcase nav-icon"></i> Vendors & Team</div>

            <div class="section-header">Quick Actions</div>
            <div class="px-4 space-y-2">
                <button onclick="openModal('customer')" class="w-full text-left px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm rounded-lg transition shadow flex items-center gap-3 font-medium">
                    <i class="fa-solid fa-plus w-5"></i> New Customer
                </button>
                <button onclick="openModal('vendor')" class="w-full text-left px-4 py-2 bg-indigo-800 hover:bg-indigo-700 text-indigo-100 text-sm rounded-lg transition flex items-center gap-3 font-medium">
                    <i class="fa-solid fa-building w-5"></i> New Vendor
                </button>
                <button onclick="openModal('task')" class="w-full text-left px-4 py-2 bg-indigo-900 hover:bg-indigo-800 text-indigo-200 text-sm rounded-lg transition flex items-center gap-3 font-medium">
                    <i class="fa-solid fa-clock w-5"></i> Quick Schedule
                </button>
            </div>

            <div class="section-header">Data Tools</div>
            <div class="px-4 flex gap-2 mb-6">
                <button onclick="exportData()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-2 rounded text-slate-200 font-medium transition">
                    <i class="fa-solid fa-download mr-1"></i> Export
                </button>
                <button onclick="resetSystem()" class="flex-1 bg-red-900 hover:bg-red-800 text-xs py-2 rounded text-white font-medium transition">
                    <i class="fa-solid fa-trash mr-1"></i> Reset
                </button>
            </div>
        </div>

        <div class="p-4 bg-indigo-950 border-t border-indigo-900">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-indigo-400 uppercase">ADDRESS BOOK</span>
                <span class="text-[10px] text-indigo-500">LocalStorage Active</span>
            </div>
            <div class="relative">
                <i class="fa-solid fa-search absolute left-3 top-2.5 text-indigo-400 text-xs"></i>
                <input type="text" id="addrSearch" onkeyup="filterAddressBook()" placeholder="Find customer..." class="w-full bg-indigo-900 border border-indigo-800 text-white text-sm rounded pl-8 pr-3 py-2 focus:ring-1 focus:ring-indigo-500 outline-none placeholder-indigo-400 transition">
            </div>
            <div id="addressBookList" class="h-32 overflow-y-auto mt-2 pr-1 custom-scroll">
                </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="flex justify-between items-center mb-8 sticky top-0 bg-[#f3f4f6] py-2 z-10 backdrop-blur-sm bg-opacity-90">
            <div>
                <h2 id="pageTitle" class="text-3xl font-bold text-slate-800">Dashboard</h2>
                <p id="pageSubtitle" class="text-slate-500 text-sm mt-1">Welcome back to your CRM.</p>
            </div>
            <div class="flex items-center gap-4">
                <div id="contextBadge" class="hidden items-center bg-white px-4 py-2 rounded-full shadow-sm border border-indigo-100 transition animate-pulse">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                    <span class="text-xs text-gray-500 mr-1">Active:</span>
                    <span id="contextName" class="text-sm font-bold text-indigo-700">Customer Name</span>
                    <button onclick="clearContext()" class="ml-3 text-gray-400 hover:text-red-500"><i class="fa-solid fa-circle-xmark"></i></button>
                </div>
                <div class="h-10 w-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-md border-2 border-white">DL</div>
            </div>
        </header>

        <div id="viewContainer" class="animate-fade-in">
            </div>
    </main>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-box">
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Title</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 transition"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>
            <div id="modalContent">
                </div>
        </div>
    </div<script>
        // === 1. CENTRAL DATABASE ===
        let db = {
            customers: [],
            vendors: [],
            orders: [],
            tasks: [],
            pipeline: [],
            activeContextId: null
        };

        // === 2. INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load data from browser storage
            try {
                const saved = localStorage.getItem('acoustiskin_crm_v2');
                if (saved) {
                    db = JSON.parse(saved);
                } else {
                    seedData(); // Load dummy data if empty
                }
            } catch (e) {
                console.error("Data load error", e);
                seedData();
            }
            
            // Setup UI
            refreshAddressBook();
            updateContextBadge();
            switchView('dashboard'); // Default page
        });

        // === 3. DATA MANAGEMENT ===
        function seedData() {
            // Factory Reset Data
            db = {
                customers: [
                    { id: 'c1', name: 'Pickleball Kingdom', email: 'buyer@pbkingdom.com', phone: '555-0199', status: 'Active', type: 'Wholesale' },
                    { id: 'c2', name: 'Dana Lurie', email: 'dana@test.com', phone: '555-0100', status: 'Active', type: 'Internal' },
                    { id: 'c3', name: 'Courtside Pro Shop', email: 'info@courtside.com', phone: '555-0123', status: 'Prospect', type: 'Retail' }
                ],
                vendors: [
                    { id: 'v1', name: '3M Supplies', contact: 'Jim', type: 'Materials' },
                    { id: 'v2', name: 'FedEx', contact: 'Support', type: 'Shipping' }
                ],
                orders: [
                    { id: '1001', customerId: 'c1', customerName: 'Pickleball Kingdom', date: '2023-10-24', total: 1250.00, status: 'Shipped' },
                    { id: '1002', customerId: 'c3', customerName: 'Courtside Pro Shop', date: '2023-11-15', total: 89.95, status: 'Processing' }
                ],
                tasks: [
                    { id: 't1', title: 'Follow up on invoice #1001', date: new Date().toISOString().split('T')[0], type: 'Email' }
                ],
                pipeline: [
                    { id: 'p1', title: 'Holiday Bulk Order', customer: 'Pickleball Kingdom', value: 5000, stage: 'Negotiation' },
                    { id: 'p2', title: 'New Franchise Deal', customer: 'Courtside Pro Shop', value: 12000, stage: 'Lead' }
                ],
                activeContextId: null
            };
            saveData();
        }

        function saveData() {
            localStorage.setItem('acoustiskin_crm_v2', JSON.stringify(db));
            refreshAddressBook();
            updateContextBadge();
        }

        function resetSystem() {
            if(confirm("WARNING: This will wipe all data and reset to factory defaults. Continue?")) {
                localStorage.removeItem('acoustiskin_crm_v2');
                location.reload();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "acoustiskin_backup.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        // === 4. NAVIGATION ROUTER ===
        function switchView(viewName) {
            // Highlight Sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById('nav-' + viewName);
            if(activeNav) activeNav.classList.add('active');

            // Set Titles
            const title = document.getElementById('pageTitle');
            const sub = document.getElementById('pageSubtitle');
            const container = document.getElementById('viewContainer');

            // Render Logic
            if(viewName === 'dashboard') {
                title.innerText = "Dashboard";
                sub.innerText = "Business Overview";
                renderDashboard(container);
            } else if(viewName === 'customers') {
                title.innerText = "Customers";
                sub.innerText = "Client Database";
                renderCustomers(container);
            } else if(viewName === 'new-order') {
                title.innerText = "New Order";
                sub.innerText = "Create Sales Order";
                renderNewOrder(container);
            } else if(viewName === 'order-tracking') {
                title.innerText = "Order Tracking";
                sub.innerText = "Status Monitoring";
                renderOrderTracking(container);
            } else if(viewName === 'calendar') {
                title.innerText = "Calendar";
                sub.innerText = "Tasks & Agenda";
                renderCalendar(container);
            } else if(viewName === 'pipeline') {
                title.innerText = "Pipeline";
                sub.innerText = "Deal Flow";
                renderPipeline(container);
            } else if(viewName === 'reports') {
                title.innerText = "Reports";
                sub.innerText = "Performance Analytics";
                renderReports(container);
            } else if(viewName === 'vendors') {
                title.innerText = "Vendors";
                sub.innerText = "Supply Chain & Team";
                renderVendors(container);
            }
        }

        // === 5. RENDER FUNCTIONS (The Modules) ===

        function renderDashboard(t) {
            const rev = db.orders.reduce((a,b) => a + b.total, 0);
            t.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="card border-l-4 border-indigo-500 stat-card">
                        <div class="text-gray-500 text-xs font-bold uppercase">Revenue</div>
                        <div class="text-2xl font-bold text-indigo-700">$${rev.toLocaleString()}</div>
                    </div>
                    <div class="card border-l-4 border-green-500 stat-card">
                        <div class="text-gray-500 text-xs font-bold uppercase">Active Customers</div>
                        <div class="text-2xl font-bold text-green-700">${db.customers.length}</div>
                    </div>
                    <div class="card border-l-4 border-blue-500 stat-card">
                        <div class="text-gray-500 text-xs font-bold uppercase">Open Deals</div>
                        <div class="text-2xl font-bold text-blue-700">${db.pipeline.length}</div>
                    </div>
                    <div class="card border-l-4 border-orange-500 stat-card">
                        <div class="text-gray-500 text-xs font-bold uppercase">Tasks</div>
                        <div class="text-2xl font-bold text-orange-700">${db.tasks.length}</div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="font-bold mb-4 text-gray-700">Recent Orders</h3>
                    ${db.orders.slice(0,5).map(o => `
                        <div class="flex justify-between border-b py-3 last:border-0">
                            <div><span class="font-bold text-indigo-600">#${o.id}</span> <span class="text-gray-600 ml-2">${o.customerName}</span></div>
                            <div class="font-bold">$${o.total.toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderCustomers(t) {
            t.innerHTML = `
                <div class="card p-0 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                            <tr><th class="p-4">Name</th><th class="p-4">Email</th><th class="p-4">Type</th><th class="p-4">Action</th></tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${db.customers.map(c => `
                                <tr class="hover:bg-indigo-50 transition">
                                    <td class="p-4 font-bold text-indigo-700 cursor-pointer" onclick="setContext('${c.id}')">${c.name}</td>
                                    <td class="p-4 text-gray-600">${c.email}</td>
                                    <td class="p-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${c.type}</span></td>
                                    <td class="p-4"><button class="text-indigo-600 font-bold hover:underline" onclick="setContext('${c.id}'); switchView('new-order')">Create Order</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        function renderNewOrder(t) {
            const c = db.customers.find(x => x.id === db.activeContextId);
            if(!c) {
                t.innerHTML = `<div class="card text-center py-10"><h3 class="text-xl font-bold text-gray-400">No Customer Selected</h3><p class="text-gray-500 mb-4">Select a customer from the sidebar first.</p><button onclick="switchView('customers')" class="bg-indigo-600 text-white px-4 py-2 rounded">Go to Customers</button></div>`;
                return;
            }
            t.innerHTML = `
                <div class="max-w-2xl mx-auto card border-t-4 border-indigo-600">
                    <h3 class="text-xl font-bold mb-6 border-b pb-2">New Order for <span class="text-indigo-600">${c.name}</span></h3>
                    <form onsubmit="submitOrder(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-600 mb-1">Product Line</label>
                            <select id="ordProd" class="w-full border p-2 rounded bg-gray-50">
                                <option value="29.95">AcoustiSkin Standard ($29.95)</option>
                                <option value="35.00">AcoustiSkin Custom ($35.00)</option>
                                <option value="15.00">Overgrip Pack ($15.00)</option>
                                <option value="150.00">Wholesale 10-Pack ($150.00)</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-600 mb-1">Quantity</label>
                            <input id="ordQty" type="number" value="1" min="1" class="w-full border p-2 rounded bg-gray-50">
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded shadow-lg transition">Process Order</button>
                        </div>
                    </form>
                </div>`;
        }

        function renderOrderTracking(t) {
            t.innerHTML = `
                <div class="card p-0 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                            <tr><th class="p-4">Order ID</th><th class="p-4">Customer</th><th class="p-4">Status</th><th class="p-4">Total</th></tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${db.orders.map(o => `
                                <tr>
                                    <td class="p-4 font-mono font-bold text-indigo-600">#${o.id}</td>
                                    <td class="p-4">${o.customerName}</td>
                                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${o.status==='Shipped'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${o.status}</span></td>
                                    <td class="p-4 font-bold">$${o.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        function renderCalendar(t) {
            t.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold text-lg mb-4 text-indigo-900">Task List</h3>
                        <div class="space-y-3">
                            ${db.tasks.length === 0 ? '<p class="text-gray-400 italic">No tasks scheduled.</p>' : ''}
                            ${db.tasks.map(tsk => `
                                <div class="flex justify-between items-center p-3 border rounded bg-gray-50">
                                    <div>
                                        <div class="font-bold text-gray-800">${tsk.title}</div>
                                        <div class="text-xs text-gray-500">${tsk.date} • ${tsk.type}</div>
                                    </div>
                                    <button onclick="deleteTask('${tsk.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card bg-indigo-50 border-indigo-100">
                        <h3 class="font-bold text-lg mb-4 text-indigo-900">Add Task</h3>
                        <form onsubmit="addTask(event)">
                            <input type="text" id="quickTaskTitle" placeholder="Task description..." class="w-full border p-2 rounded mb-3" required>
                            <input type="date" id="quickTaskDate" class="w-full border p-2 rounded mb-3" required>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 rounded hover:bg-indigo-700">Save Task</button>
                        </form>
                    </div>
                </div>`;
        }

        function renderPipeline(t) {
            const stages = ['Lead', 'Negotiation', 'Closed Won'];
            t.innerHTML = `
                <div class="kanban-container">
                    ${stages.map(stage => `
                        <div class="kanban-col">
                            <div class="flex justify-between mb-3 px-1">
                                <span class="font-bold text-xs text-gray-500 uppercase tracking-wider">${stage}</span>
                                <span class="bg-gray-200 text-gray-600 text-xs font-bold px-2 rounded-full">${db.pipeline.filter(p=>p.stage===stage).length}</span>
                            </div>
                            <div class="space-y-2 overflow-y-auto flex-1">
                                ${db.pipeline.filter(p => p.stage === stage).map(d => `
                                    <div class="kanban-card group">
                                        <div class="font-bold text-sm text-gray-800">${d.title}</div>
                                        <div class="text-xs text-gray-500 mb-2">${d.customer}</div>
                                        <div class="flex justify-between items-center border-t pt-2">
                                            <span class="font-bold text-indigo-600 text-xs">$${d.value.toLocaleString()}</span>
                                            <div>
                                                ${stage!=='Closed Won' ? `<button onclick="advanceDeal('${d.id}')" class="text-green-600 text-xs font-bold mr-2">Move ></button>` : ''}
                                                <button onclick="deleteDeal('${d.id}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderReports(t) {
            t.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold text-lg mb-4">Top Customers</h3>
                        <ul class="space-y-2">
                            ${db.customers.slice(0,5).map((c, i) => `<li class="flex justify-between p-2 border-b"><span>${i+1}. ${c.name}</span> <span class="text-gray-400">${c.type}</span></li>`).join('')}
                        </ul>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-lg mb-4">Performance</h3>
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden mb-2">
                            <div class="h-full bg-indigo-600" style="width: 65%"></div>
                        </div>
                        <p class="text-sm text-gray-500">65% of Monthly Goal Achieved</p>
                    </div>
                </div>`;
        }

        function renderVendors(t) {
            t.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">Vendor List</h3>
                            <button onclick="openModal('vendor')" class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-200">+ Add</button>
                        </div>
                        ${db.vendors.map(v => `<div class="p-3 border rounded mb-2 bg-gray-50"><strong>${v.name}</strong><br><span class="text-xs text-gray-500">${v.type} • ${v.contact}</span></div>`).join('')}
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-lg mb-4">Internal Team</h3>
                        <div class="flex items-center gap-3 p-3 border rounded bg-indigo-50 border-indigo-100 mb-2">
                            <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">DL</div>
                            <div><div class="font-bold text-sm">Dana Lurie</div><div class="text-xs text-indigo-600 font-bold">Owner / Admin</div></div>
                        </div>
                         <div class="flex items-center gap-3 p-3 border rounded mb-2">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold">A</div>
                            <div><div class="font-bold text-sm">Allyson</div><div class="text-xs text-gray-500">Affiliate Manager</div></div>
                        </div>
                    </div>
                </div>`;
        }

        // === 6. LOGIC ACTIONS ===
        
        // Context
        function setContext(id) { db.activeContextId = id; saveData(); }
        function clearContext() { db.activeContextId = null; saveData(); }
        function updateContextBadge() {
            const el = document.getElementById('contextBadge');
            const nameEl = document.getElementById('contextName');
            if(db.activeContextId) {
                const c = db.customers.find(x=>x.id===db.activeContextId);
                nameEl.innerText = c ? c.name : 'Unknown';
                el.classList.remove('hidden'); el.classList.add('flex');
            } else { el.classList.add('hidden'); el.classList.remove('flex'); }
            // Visual address book highlight
            document.querySelectorAll('.addr-item').forEach(i => i.classList.remove('active-ctx'));
            const activeAddr = document.getElementById('addr-'+db.activeContextId);
            if(activeAddr) activeAddr.classList.add('active-ctx');
        }

        // Address Book
        function refreshAddressBook() {
            const list = document.getElementById('addressBookList');
            list.innerHTML = db.customers.map(c => `
                <div id="addr-${c.id}" class="addr-item" onclick="setContext('${c.id}')">
                    <span>${c.name}</span>
                    ${db.activeContextId === c.id ? '<i class="fa-solid fa-check text-xs"></i>' : ''}
                </div>
            `).join('');
        }
        function filterAddressBook() {
            const term = document.getElementById('addrSearch').value.toLowerCase();
            document.querySelectorAll('.addr-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(term) ? 'flex' : 'none');
        }

        // Order Logic
        function submitOrder(e) {
            e.preventDefault();
            const qty = document.getElementById('ordQty').value;
            const price = document.getElementById('ordProd').value;
            const c = db.customers.find(x=>x.id===db.activeContextId);
            
            db.orders.unshift({
                id: Math.floor(Math.random() * 9000) + 1000,
                customerId: c.id,
                customerName: c.name,
                date: new Date().toISOString().split('T')[0],
                total: qty * price,
                status: 'Processing'
            });
            saveData();
            alert("Order Successfully Created!");
            switchView('order-tracking');
        }

        // Task Logic
        function addTask(e) {
            e.preventDefault();
            const title = e.target.querySelector('input[type="text"]').value;
            const date = e.target.querySelector('input[type="date"]').value || new Date().toISOString().split('T')[0];
            
            db.tasks.push({ id: 't'+Date.now(), title: title, date: date, type: 'General' });
            saveData();
            closeModal(); // in case it came from modal
            switchView('calendar'); // Refresh view
        }
        function deleteTask(id) {
            if(confirm("Delete task?")) {
                db.tasks = db.tasks.filter(t => t.id !== id);
                saveData();
                switchView('calendar');
            }
        }

        // Pipeline Logic
        function advanceDeal(id) {
            const d = db.pipeline.find(p=>p.id===id);
            if(d.stage === 'Lead') d.stage = 'Negotiation';
            else if(d.stage === 'Negotiation') d.stage = 'Closed Won';
            saveData();
            switchView('pipeline');
        }
        function deleteDeal(id) {
            if(confirm("Delete deal?")) {
                db.pipeline = db.pipeline.filter(p=>p.id!==id);
                saveData();
                switchView('pipeline');
            }
        }

        // Modal Logic
        function openModal(type) {
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            overlay.style.display = 'flex';
            
            if(type === 'customer') {
                title.innerText = "New Customer";
                content.innerHTML = `
                    <form onsubmit="addCustomer(event)">
                        <input name="name" placeholder="Company Name" class="w-full border p-2 rounded mb-3" required>
                        <input name="email" placeholder="Email" class="w-full border p-2 rounded mb-3">
                        <select name="type" class="w-full border p-2 rounded mb-3"><option>Wholesale</option><option>Retail</option></select>
                        <button class="w-full bg-indigo-600 text-white font-bold py-2 rounded">Save</button>
                    </form>`;
            } else if (type === 'vendor') {
                title.innerText = "New Vendor";
                content.innerHTML = `
                     <form onsubmit="addVendor(event)">
                        <input name="name" placeholder="Vendor Name" class="w-full border p-2 rounded mb-3" required>
                        <input name="contact" placeholder="Contact Person" class="w-full border p-2 rounded mb-3">
                        <button class="w-full bg-indigo-800 text-white font-bold py-2 rounded">Save</button>
                    </form>`;
            } else if (type === 'task') {
                title.innerText = "Quick Task";
                content.innerHTML = `
                     <form onsubmit="addTask(event)">
                        <input type="text" placeholder="Task Description" class="w-full border p-2 rounded mb-3" required>
                        <input type="date" class="w-full border p-2 rounded mb-3">
                        <button class="w-full bg-indigo-900 text-white font-bold py-2 rounded">Save</button>
                    </form>`;
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function addCustomer(e) {
            e.preventDefault();
            const f = new FormData(e.target);
            const id = 'c' + Date.now();
            db.customers.push({
                id: id,
                name: e.target.querySelector('input[name="name"]').value,
                email: e.target.querySelector('input[name="email"]').value,
                type: e.target.querySelector('select[name="type"]').value,
                status: 'Prospect'
            });
            setContext(id);
            saveData();
            closeModal();
            switchView('customers');
        }

        function addVendor(e) {
            e.preventDefault();
            db.vendors.push({
                id: 'v' + Date.now(),
                name: e.target.querySelector('input[name="name"]').value,
                contact: e.target.querySelector('input[name="contact"]').value,
                type: 'General'
            });
            saveData();
            closeModal();
            switchView('vendors');
        }
    </script>
</body>
</html>
