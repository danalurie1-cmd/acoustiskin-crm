<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcoustiSkin CRM - Master Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }

        /* Sidebar */
        .sidebar { width: 260px; transition: all 0.3s ease; background: #1e1b4b; color: white; }
        .nav-item { display: flex; items-center; padding: 10px 15px; margin: 4px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; color: #c7d2fe; font-size: 0.9rem; }
        .nav-item:hover { background: #312e81; color: white; }
        .nav-item.active { background: #4f46e5; color: white; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .nav-icon { width: 24px; text-align: center; margin-right: 10px; }

        /* Main Area */
        .main-content { flex: 1; height: 100vh; overflow-y: auto; padding: 20px; }
        
        /* Cards */
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        
        /* Kanban */
        .kanban-col { min-width: 280px; background: #f3f4f6; border-radius: 8px; padding: 10px; height: 100%; }
        .kanban-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: grab; border-left: 4px solid #4f46e5; }

        /* Modal */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="sidebar flex flex-col h-full shadow-2xl z-20">
        <div class="p-6 border-b border-indigo-900 flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">AS</div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">AcoustiSkin</h1>
                <p class="text-xs text-indigo-300 uppercase tracking-wider">CRM Pro</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-4">
            <div class="px-6 mb-2 text-xs font-bold text-indigo-400 uppercase tracking-wider">Core Modules</div>
            <nav>
                <div class="nav-item active" onclick="loadView('dashboard')"><i class="fa-solid fa-chart-pie nav-icon"></i> Dashboard</div>
                <div class="nav-item" onclick="loadView('customers')"><i class="fa-solid fa-users nav-icon"></i> Customers</div>
                <div class="nav-item" onclick="loadView('new-order')"><i class="fa-solid fa-cart-plus nav-icon"></i> New Order</div>
                <div class="nav-item" onclick="loadView('order-tracking')"><i class="fa-solid fa-truck-fast nav-icon"></i> Order Tracking</div>
                <div class="nav-item" onclick="loadView('calendar')"><i class="fa-regular fa-calendar-days nav-icon"></i> Calendar</div>
                <div class="nav-item" onclick="loadView('pipeline')"><i class="fa-solid fa-filter nav-icon"></i> Pipeline</div>
                <div class="nav-item" onclick="loadView('reports')"><i class="fa-solid fa-chart-line nav-icon"></i> Reports</div>
                <div class="nav-item" onclick="loadView('vendors')"><i class="fa-solid fa-briefcase nav-icon"></i> Vendors & Team</div>
            </nav>

            <div class="px-6 mt-6 mb-2 text-xs font-bold text-indigo-400 uppercase tracking-wider">Actions</div>
            <div class="px-4 space-y-2">
                <button onclick="openModal('customer')" class="w-full text-left px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm rounded-lg transition shadow-md flex items-center gap-2">
                    <i class="fa-solid fa-user-plus"></i> New Customer
                </button>
                <button onclick="openModal('vendor')" class="w-full text-left px-4 py-2 bg-indigo-800 hover:bg-indigo-700 text-indigo-100 text-sm rounded-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-building"></i> New Vendor
                </button>
                <button onclick="openModal('task')" class="w-full text-left px-4 py-2 bg-indigo-900 hover:bg-indigo-800 text-indigo-200 text-sm rounded-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-clock"></i> Quick Schedule
                </button>
            </div>

            <div class="px-6 mt-6 mb-2 text-xs font-bold text-indigo-400 uppercase tracking-wider">Data Tools</div>
            <div class="px-4 flex gap-2">
                <button onclick="exportData()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-2 rounded text-slate-300"><i class="fa-solid fa-download"></i> Export</button>
                <label class="flex-1 bg-slate-700 hover:bg-slate-600 text-xs py-2 rounded text-slate-300 text-center cursor-pointer">
                    <i class="fa-solid fa-upload"></i> Import
                    <input type="file" id="importFile" class="hidden" onchange="importData(this)">
                </label>
            </div>
        </div>

        <div class="p-4 bg-indigo-950 border-t border-indigo-900">
            <div class="text-xs font-bold text-indigo-400 mb-2 uppercase">Address Book</div>
            <input type="text" id="addrSearch" onkeyup="filterAddressBook()" placeholder="Search..." class="w-full bg-indigo-900 border-none text-white text-sm rounded p-2 mb-2 focus:ring-1 focus:ring-indigo-500 outline-none placeholder-indigo-400">
            <div id="addressBookList" class="h-32 overflow-y-auto space-y-1">
                </div>
        </div>
    </aside>

    <main class="main-content bg-gray-50">
        <header class="flex justify-between items-center mb-8">
            <h2 id="pageTitle" class="text-2xl font-bold text-slate-800">Dashboard</h2>
            <div class="flex items-center gap-4">
                <div id="activeCustomerBadge" class="hidden px-4 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold border border-green-200">
                    Active: <span id="activeCustomerName">None</span>
                </div>
                <div class="h-10 w-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">DL</div>
            </div>
        </header>

        <div id="viewContainer">
            </div>
    </main>

    <div id="genericModal" class="modal-backdrop">
        <div class="modal-content animate-fade-in-down">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 id="modalTitle" class="text-xl font-bold">Title</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let store = {
            customers: [],
            vendors: [],
            orders: [],
            tasks: [],
            pipeline: [],
            activeContext: null // currently selected customer ID
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadView('dashboard');
            refreshAddressBook();
        });

        function loadData() {
            const saved = localStorage.getItem('acoustiskin_db');
            if (saved) {
                store = JSON.parse(saved);
            } else {
                // SEED INITIAL DATA
                store.customers = [
                    { id: 'c1', name: 'Pickleball Kingdom', email: 'store@pbkingdom.com', phone: '555-0101', status: 'Active', type: 'Wholesale' },
                    { id: 'c2', name: 'Dana Lurie', email: 'dana@test.com', phone: '555-0102', status: 'Active', type: 'Retail' },
                    { id: 'c3', name: 'Courtside Supplies', email: 'info@courtside.com', phone: '555-0103', status: 'Prospect', type: 'Wholesale' }
                ];
                store.vendors = [
                    { id: 'v1', name: '3M Adhesive Co.', type: 'Supplier', contact: 'Jim Sales' },
                    { id: 'v2', name: 'FedEx Corp', type: 'Logistics', contact: 'Support' }
                ];
                store.pipeline = [
                    { id: 'p1', title: 'Bulk Order - 500 Units', customer: 'Pickleball Kingdom', value: 12000, stage: 'Negotiation' },
                    { id: 'p2', title: 'New Retail Partnership', customer: 'Courtside Supplies', value: 5000, stage: 'Lead' }
                ];
                store.tasks = [
                    { id: 't1', title: 'Call 3M regarding adhesive stock', date: new Date().toISOString().split('T')[0], type: 'Call' }
                ];
                store.orders = [
                    { id: 'ORD-1001', customerId: 'c1', date: '2023-11-01', total: 450.00, status: 'Shipped' }
                ];
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('acoustiskin_db', JSON.stringify(store));
            refreshAddressBook();
        }

        // --- NAVIGATION & VIEWS ---
        function loadView(viewName) {
            // Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event?.currentTarget?.classList.add('active');

            const container = document.getElementById('viewContainer');
            const title = document.getElementById('pageTitle');
            
            // ROUTER
            switch(viewName) {
                case 'dashboard':
                    title.innerText = 'Dashboard';
                    renderDashboard(container);
                    break;
                case 'customers':
                    title.innerText = 'Customer Database';
                    renderCustomers(container);
                    break;
                case 'new-order':
                    title.innerText = 'Create New Order';
                    renderNewOrder(container);
                    break;
                case 'order-tracking':
                    title.innerText = 'Order Tracking';
                    renderOrderTracking(container);
                    break;
                case 'calendar':
                    title.innerText = 'Schedule & Tasks';
                    renderCalendar(container);
                    break;
                case 'pipeline':
                    title.innerText = 'Sales Pipeline';
                    renderPipeline(container);
                    break;
                case 'reports':
                    title.innerText = 'Performance Reports';
                    renderReports(container);
                    break;
                case 'vendors':
                    title.innerText = 'Vendors & Team';
                    renderVendors(container);
                    break;
            }
        }

        // --- RENDER FUNCTIONS (THE MODULES) ---

        function renderDashboard(target) {
            const revenue = store.orders.reduce((acc, o) => acc + o.total, 0);
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="card border-l-4 border-indigo-500">
                        <div class="text-gray-500 text-sm font-bold uppercase">Total Revenue</div>
                        <div class="text-2xl font-bold text-indigo-700">$${revenue.toLocaleString()}</div>
                    </div>
                    <div class="card border-l-4 border-green-500">
                        <div class="text-gray-500 text-sm font-bold uppercase">Active Customers</div>
                        <div class="text-2xl font-bold text-green-700">${store.customers.length}</div>
                    </div>
                    <div class="card border-l-4 border-yellow-500">
                        <div class="text-gray-500 text-sm font-bold uppercase">Open Deals</div>
                        <div class="text-2xl font-bold text-yellow-700">${store.pipeline.length}</div>
                    </div>
                    <div class="card border-l-4 border-red-500">
                        <div class="text-gray-500 text-sm font-bold uppercase">Pending Tasks</div>
                        <div class="text-2xl font-bold text-red-700">${store.tasks.length}</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold mb-4 text-gray-700">Recent Activity</h3>
                        <ul class="space-y-3 text-sm">
                            ${store.orders.slice(0,3).map(o => `<li class="flex justify-between border-b pb-2"><span>New Order #${o.id}</span> <span class="font-bold">$${o.total}</span></li>`).join('')}
                            <li class="flex justify-between border-b pb-2 text-gray-500"><span>System backup created</span> <span>Today</span></li>
                        </ul>
                    </div>
                    <div class="card bg-indigo-900 text-white">
                        <h3 class="font-bold mb-2">Quick Note</h3>
                        <textarea class="w-full bg-indigo-800 rounded p-2 text-sm text-white h-32 border-none focus:ring-2 focus:ring-indigo-400" placeholder="Type a note here..."></textarea>
                    </div>
                </div>
            `;
        }

        function renderCustomers(target) {
            target.innerHTML = `
                <div class="card overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr><th class="p-3">Name</th><th class="p-3">Email</th><th class="p-3">Type</th><th class="p-3">Status</th><th class="p-3">Action</th></tr>
                        </thead>
                        <tbody class="divide-y">
                            ${store.customers.map(c => `
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="p-3 font-medium text-indigo-700 cursor-pointer" onclick="selectContext('${c.id}')">${c.name}</td>
                                    <td class="p-3 text-sm text-gray-600">${c.email}</td>
                                    <td class="p-3 text-sm">${c.type}</td>
                                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${c.status==='Active'?'bg-green-100 text-green-700':'bg-gray-100 text-gray-600'}">${c.status}</span></td>
                                    <td class="p-3"><button class="text-indigo-600 hover:underline text-sm" onclick="selectContext('${c.id}'); loadView('new-order')">Order</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        function renderNewOrder(target) {
            if(!store.activeContext) {
                target.innerHTML = `<div class="text-center mt-10"><div class="text-gray-400 text-lg">Please select a customer from the "Customers" tab or Address Book first.</div></div>`;
                return;
            }
            const customer = store.customers.find(c => c.id === store.activeContext);
            target.innerHTML = `
                <div class="max-w-3xl mx-auto card">
                    <div class="border-b pb-4 mb-4 flex justify-between">
                        <div>
                            <span class="text-xs text-gray-500 uppercase">Customer</span>
                            <div class="font-bold text-lg text-indigo-700">${customer.name}</div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-500 uppercase">Date</span>
                            <div class="font-bold">${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                    <form id="orderForm" onsubmit="submitOrder(event)">
                        <div class="space-y-4 mb-6">
                            <div class="grid grid-cols-3 gap-4 font-bold text-xs text-gray-500 uppercase">
                                <div class="col-span-2">Item</div>
                                <div>Price</div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 items-center">
                                <div class="col-span-2">
                                    <select name="item" class="w-full p-2 border rounded bg-gray-50">
                                        <option value="29.95">AcoustiSkin Standard ($29.95)</option>
                                        <option value="35.00">AcoustiSkin Custom ($35.00)</option>
                                        <option value="150.00">Retail Pack (10 units) ($150.00)</option>
                                    </select>
                                </div>
                                <div><input type="number" name="qty" value="1" min="1" class="w-20 p-2 border rounded"></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded flex justify-between items-center mb-6">
                            <span class="font-bold text-gray-600">Shipping Method:</span>
                            <select class="p-2 border rounded"><option>Standard Ground</option><option>FedEx 2-Day</option></select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded shadow-lg">Create Order</button>
                    </form>
                </div>
            `;
        }

        function renderOrderTracking(target) {
            target.innerHTML = `
                 <div class="card">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="p-3">Order ID</th><th class="p-3">Customer</th><th class="p-3">Date</th><th class="p-3">Total</th><th class="p-3">Status</th></tr></thead>
                        <tbody>
                            ${store.orders.map(o => {
                                const cName = store.customers.find(c => c.id === o.customerId)?.name || 'Unknown';
                                return `<tr class="border-b last:border-0">
                                    <td class="p-3 font-mono text-sm">${o.id}</td>
                                    <td class="p-3">${cName}</td>
                                    <td class="p-3 text-sm text-gray-500">${o.date}</td>
                                    <td class="p-3 font-bold">$${o.total.toFixed(2)}</td>
                                    <td class="p-3"><span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">${o.status}</span></td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                 </div>`;
        }

        function renderCalendar(target) {
            const today = new Date().toISOString().split('T')[0];
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                    <div class="card md:col-span-2">
                        <h3 class="font-bold mb-4">Upcoming Tasks</h3>
                        <div class="space-y-2">
                            ${store.tasks.map(t => `
                                <div class="flex items-center p-3 border rounded hover:bg-gray-50">
                                    <div class="w-2 h-full bg-${t.type==='Call'?'blue':t.type==='Meeting'?'purple':'green'}-500 mr-3 rounded-full"></div>
                                    <div class="flex-1">
                                        <div class="font-bold text-sm">${t.title}</div>
                                        <div class="text-xs text-gray-500">${t.date} • ${t.type}</div>
                                    </div>
                                    <button class="text-red-400 hover:text-red-600" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            `).join('')}
                            ${store.tasks.length === 0 ? '<div class="text-gray-400 text-sm italic">No tasks scheduled. Use "Quick Schedule" to add one.</div>' : ''}
                        </div>
                    </div>
                    <div class="card bg-indigo-50 border-indigo-100">
                        <h3 class="font-bold mb-4 text-indigo-800">Quick Add</h3>
                        <form onsubmit="addTask(event)">
                            <input type="text" name="title" placeholder="Task description..." class="w-full p-2 mb-2 border rounded" required>
                            <input type="date" name="date" value="${today}" class="w-full p-2 mb-2 border rounded" required>
                            <select name="type" class="w-full p-2 mb-4 border rounded"><option>Call</option><option>Meeting</option><option>Email</option><option>Todo</option></select>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded font-bold">Add to Schedule</button>
                        </form>
                    </div>
                </div>`;
        }

        function renderPipeline(target) {
            const stages = ['Lead', 'Negotiation', 'Closed Won'];
            target.innerHTML = `
                <div class="flex gap-4 h-full overflow-x-auto pb-4">
                    ${stages.map(stage => `
                        <div class="kanban-col shadow-inner flex-shrink-0 w-72">
                            <h4 class="font-bold text-gray-600 mb-3 uppercase text-xs flex justify-between items-center">
                                ${stage} <span class="bg-gray-200 px-2 py-1 rounded text-gray-600">${store.pipeline.filter(p => p.stage === stage).length}</span>
                            </h4>
                            <div class="space-y-2">
                                ${store.pipeline.filter(p => p.stage === stage).map(deal => `
                                    <div class="kanban-card group relative">
                                        <div class="font-bold text-gray-800 text-sm">${deal.title}</div>
                                        <div class="text-xs text-gray-500 mt-1">${deal.customer}</div>
                                        <div class="mt-2 flex justify-between items-center">
                                            <span class="text-indigo-600 font-bold text-xs">$${deal.value.toLocaleString()}</span>
                                        </div>
                                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                                            ${stage !== 'Closed Won' ? `<button onclick="moveDeal('${deal.id}', 'Closed Won')" class="text-green-500 hover:text-green-700 text-xs" title="Mark Won"><i class="fa-solid fa-check"></i></button>` : ''}
                                            <button onclick="deleteDeal('${deal.id}')" class="text-red-400 hover:text-red-600 text-xs ml-2"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderReports(target) {
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold mb-4">Monthly Revenue</h3>
                        <div class="h-48 flex items-end justify-between px-4 space-x-2 border-b border-l border-gray-200 pb-2">
                             <div class="w-full bg-indigo-200 hover:bg-indigo-300 rounded-t transition relative group h-[40%]"></div>
                             <div class="w-full bg-indigo-200 hover:bg-indigo-300 rounded-t transition relative group h-[60%]"></div>
                             <div class="w-full bg-indigo-200 hover:bg-indigo-300 rounded-t transition relative group h-[30%]"></div>
                             <div class="w-full bg-indigo-500 hover:bg-indigo-600 rounded-t transition relative group h-[85%]"></div>
                             <div class="w-full bg-gray-100 rounded-t h-[10%]"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2 px-4">
                            <span>Jul</span><span>Aug</span><span>Sep</span><span>Oct</span><span>Nov</span>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">Top Customers</h3>
                        <ul class="space-y-3">
                            ${store.customers.slice(0,4).map(c => `
                                <li class="flex justify-between items-center">
                                    <span class="text-sm text-gray-700">${c.name}</span>
                                    <div class="w-24 bg-gray-100 rounded-full h-2 overflow-hidden">
                                        <div class="bg-green-500 h-full" style="width: ${Math.random() * 100}%"></div>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>`;
        }

        function renderVendors(target) {
            target.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-xl mb-4">Vendors</h3>
                        <div class="space-y-3">
                            ${store.vendors.map(v => `
                                <div class="card flex justify-between items-center">
                                    <div>
                                        <div class="font-bold">${v.name}</div>
                                        <div class="text-xs text-gray-500">${v.type} • ${v.contact}</div>
                                    </div>
                                    <button class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl mb-4">Internal Team</h3>
                        <div class="card flex items-center gap-4 mb-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">DL</div>
                            <div>
                                <div class="font-bold">Dana Lurie</div>
                                <div class="text-xs text-gray-500">Owner / Admin</div>
                            </div>
                        </div>
                         <div class="card flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-700 font-bold">A</div>
                            <div>
                                <div class="font-bold">Allyson</div>
                                <div class="text-xs text-gray-500">Affiliate Manager</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- MODALS & ACTIONS ---
        function openModal(type) {
            const modal = document.getElementById('genericModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            modal.style.display = 'flex';
            
            if (type === 'customer') {
                title.innerText = 'New Customer';
                body.innerHTML = `
                    <form onsubmit="createCustomer(event)" class="space-y-4">
                        <input type="text" name="name" placeholder="Company Name" class="w-full border p-2 rounded" required>
                        <input type="email" name="email" placeholder="Email Address" class="w-full border p-2 rounded">
                        <input type="text" name="phone" placeholder="Phone" class="w-full border p-2 rounded">
                        <select name="type" class="w-full border p-2 rounded"><option>Wholesale</option><option>Retail</option></select>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded font-bold">Create Customer</button>
                    </form>
                `;
            } else if (type === 'vendor') {
                title.innerText = 'New Vendor';
                body.innerHTML = `
                    <form onsubmit="createVendor(event)" class="space-y-4">
                        <input type="text" name="name" placeholder="Vendor Name" class="w-full border p-2 rounded" required>
                        <input type="text" name="type" placeholder="Service Type (e.g. Logistics)" class="w-full border p-2 rounded">
                        <input type="text" name="contact" placeholder="Contact Person" class="w-full border p-2 rounded">
                        <button type="submit" class="w-full bg-indigo-800 text-white py-2 rounded font-bold">Add Vendor</button>
                    </form>
                `;
            } else if (type === 'task') {
                title.innerText = 'Quick Schedule Task';
                body.innerHTML = `
                    <form onsubmit="addTask(event)" class="space-y-4">
                        <input type="text" name="title" placeholder="Task Description" class="w-full border p-2 rounded" required>
                        <input type="date" name="date" class="w-full border p-2 rounded" required>
                        <select name="type" class="w-full border p-2 rounded"><option>Call</option><option>Meeting</option><option>Email</option></select>
                        <button type="submit" class="w-full bg-indigo-900 text-white py-2 rounded font-bold">Schedule</button>
                    </form>
                `;
            }
        }

        function closeModal() {
            document.getElementById('genericModal').style.display = 'none';
        }

        // --- CRUD LOGIC ---
        function createCustomer(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            const newC = {
                id: 'c' + Date.now(),
                name: data.get('name'),
                email: data.get('email'),
                phone: data.get('phone'),
                type: data.get('type'),
                status: 'Prospect'
            };
            store.customers.push(newC);
            saveData();
            closeModal();
            loadView('customers');
            refreshAddressBook();
        }

        function createVendor(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            store.vendors.push({
                id: 'v' + Date.now(),
                name: data.get('name'),
                type: data.get('type'),
                contact: data.get('contact')
            });
            saveData();
            closeModal();
            loadView('vendors');
        }

        function addTask(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            store.tasks.push({
                id: 't' + Date.now(),
                title: data.get('title'),
                date: data.get('date'),
                type: data.get('type')
            });
            saveData();
            closeModal();
            if(document.getElementById('pageTitle').innerText === 'Schedule & Tasks') loadView('calendar');
            else alert('Task Added!');
        }

        function submitOrder(e) {
            e.preventDefault();
            const form = e.target;
            const itemPrice = parseFloat(form.querySelector('[name="item"]').value);
            const qty = parseInt(form.querySelector('[name="qty"]').value);
            const total = itemPrice * qty;
            
            store.orders.push({
                id: 'ORD-' + Math.floor(Math.random() * 10000),
                customerId: store.activeContext,
                date: new Date().toISOString().split('T')[0],
                total: total,
                status: 'Processing'
            });
            saveData();
            alert('Order Created Successfully!');
            loadView('order-tracking');
        }

        function moveDeal(id, stage) {
            const deal = store.pipeline.find(d => d.id === id);
            if(deal) {
                deal.stage = stage;
                saveData();
                loadView('pipeline');
            }
        }
        
        function deleteDeal(id) {
            store.pipeline = store.pipeline.filter(d => d.id !== id);
            saveData();
            loadView('pipeline');
        }

        function deleteTask(id) {
            store.tasks = store.tasks.filter(t => t.id !== id);
            saveData();
            loadView('calendar');
        }

        // --- ADDRESS BOOK & CONTEXT ---
        function refreshAddressBook() {
            const list = document.getElementById('addressBookList');
            list.innerHTML = store.customers.map(c => `
                <div onclick="selectContext('${c.id}')" class="text-indigo-200 hover:text-white hover:bg-indigo-800 px-2 py-1 rounded cursor-pointer text-sm flex justify-between items-center addr-item">
                    <span>${c.name}</span>
                </div>
            `).join('');
        }

        function filterAddressBook() {
            const term = document.getElementById('addrSearch').value.toLowerCase();
            document.querySelectorAll('.addr-item').forEach(el => {
                const txt = el.innerText.toLowerCase();
                el.style.display = txt.includes(term) ? 'flex' : 'none';
            });
        }

        function selectContext(id) {
            store.activeContext = id;
            const customer = store.customers.find(c => c.id === id);
            document.getElementById('activeCustomerBadge').classList.remove('hidden');
            document.getElementById('activeCustomerName').innerText = customer.name;
            // If user selects from sidebar, maybe take them to dashboard or new order?
            // For now, we just update state.
        }

        // --- EXPORT / IMPORT ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(store));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "acoustiskin_crm_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    store = imported;
                    saveData();
                    alert("Data imported successfully!");
                    location.reload();
                } catch (err) {
                    alert("Error reading file. Please ensure it is a valid JSON backup.");
                }
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>
